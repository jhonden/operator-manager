# 算子包打包路径配置与公共库管理 - 需求设计

> 创建日期：2026-02-21
> 版本：v1.1
> 状态：部分实施（公共库基础管理已完成）
> 最后更新：2026-02-22

---

## 1. 需求背景

### 1.1 问题描述

当前算子管理系统中，算子之间存在一些公共代码逻辑（如常量、公共算法、公共数据模型等），这些代码需要在多个算子之间共享，并在打包时一起发布到算子包中。

同时，现有的算子包结构已经投入使用，新的系统设计需要保证兼容性，避免破坏现有算子包的使用。

### 1.2 目标

1. 支持公共代码库的创建和管理，实现算子之间的代码复用
2. 灵活的打包路径配置，支持兼容现有算子包格式
3. 提供打包结构预览和冲突检测，避免打包错误
4. 统一的包级配置管理，同一个算子可以在不同包中使用不同的打包路径

---

## 2. 核心设计思路

### 2.1 架构设计

```
┌─────────────────────────────────────────────────────────┐
│                   公共库（CommonLibrary）               │
│  - 纯粹的代码库定义，支持多文件                          │
│  - 不包含任何打包路径配置                                 │
└─────────────────────┬───────────────────────────────────┘
                      │ 引用（不指定版本）
                      ▼
              ┌───────────────┐
              │   算子       │
│  - 纯粹的算子代码定义                                      │
│  - 不包含任何打包路径配置                                     │
              └───────┬───────┘
                      │ 归属
                      ▼
┌─────────────────────────────────────────────────────────┐
│                  算子包                              │
│  - 统一管理所有资源的打包路径配置                            │
│  - 在关联表中存储版本和路径配置                             │
└─────────────────────────────────────────────────────────┘
```

### 2.2 核心原则

1. **算子和公共库解耦**：算子和公共库不包含打包路径配置，只包含纯粹的代码定义
2. **包级统一配置**：打包路径配置在算子包层面统一管理
3. **灵活复用**：同一个算子可以在不同包中使用不同的打包路径
4. **向后兼容**：支持现有的算子包格式（Legacy 模板）

---

## 3. 数据模型设计

### 3.1 CommonLibrary（公共库）

| 字段名 | 类型 | 说明 | 必填 |
|-------|------|------|-----|
| id | BIGINT | 主键 | 是 |
| name | VARCHAR(255) | 公共库名称 | 是 |
| description | TEXT | 描述 | 否 |
| version | VARCHAR(50) | 版本号 | 是 |
| category | VARCHAR(100) | 分类 | 否 |
| library_type | VARCHAR(50) | 库类型（CONSTANT/METHOD/MODEL/CUSTOM） | 是 |
| created_at | TIMESTAMP | 创建时间 | 是 |
| updated_at | TIMESTAMP | 更新时间 | 是 |
| created_by | BIGINT | 创建人 | 否 |

### 3.2 CommonLibraryFile（公共库文件）

| 字段名 | 类型 | 说明 | 必填 |
|-------|------|------|-----|
| id | BIGINT | 主键 | 是 |
| library_id | BIGINT | 公共库ID（外键） | 是 |
| file_name | VARCHAR(255) | 文件名 | 是 |
| file_path | VARCHAR(500) | MinIO存储路径 | 否 |
| code | TEXT | 代码内容 | 否 |
| order_index | INTEGER | 文件顺序 | 否 |
| created_at | TIMESTAMP | 创建时间 | 是 |
| updated_at | TIMESTAMP | 更新时间 | 是 |

### 3.3 Operator（算子）- 不变更

现有的算子实体无需变更，不包含打包路径配置。

### 3.4 OperatorPackage（算子包）- 增加字段

| 字段名 | 类型 | 说明 | 必填 |
|-------|------|------|-----|
| ... | ... | ... | ... |
| package_template | VARCHAR(50) | 打包模板（legacy/modern/custom） | 否 |

### 3.5 PackageOperator（算子包-算子关联）- 增加字段

| 字段名 | 类型 | 说明 | 必填 |
|-------|------|------|-----|
| ... | ... | ... | ... |
| custom_package_path | VARCHAR(500) | 自定义打包路径 | 否 |
| use_custom_path | BOOLEAN | 是否使用自定义路径 | 是 |

### 3.6 PackageCommonLibrary（算子包-公共库关联）- 增加字段

| 字段名 | 类型 | 说明 | 必填 |
|-------|------|------|-----|
| id | BIGINT | 主键 | 是 |
| package_id | BIGINT | 算子包ID（外键） | 是 |
| library_id | BIGINT | 公共库ID（外键） | 是 |
| version | VARCHAR(50) | 指定使用的版本 | 是 |
| order_index | INTEGER | 打包顺序 | 否 |
| custom_package_path | VARCHAR(500) | 自定义打包路径 | 否 |
| use_custom_path | BOOLEAN | 是否使用自定义路径 | 是 |
| created_at | TIMESTAMP | 创建时间 | 是 |
| updated_at | TIMESTAMP | 更新时间 | 是 |

---

## 4. 打包路径系统设计

### 4.1 路径变量

| 变量 | 说明 | 示例 |
|-----|------|-----|
| `${libraryName}` | 公共库名称 | `DateUtils` |
| `${libraryVersion}` | 公共库版本 | `1.0` |
| `${operatorCode}` | 算子编码 | `my_operator` |
| `${packageName}` | 算子包名称 | `my_package` |
| `${fileName}` | 文件名 | `DateUtils.js` |
| `${fileExt}` | 文件扩展名 | `.groovy` |

### 4.2 打包模板

#### Legacy 模板（兼容现有格式）

```
{包名}/
├── models/                          # 类型为 MODEL 的库
│   └── ${fileName}
├── operators/
│   ├── constants/                   # 类型为 CONSTANT 的库
│   │   └── ${fileName}
│   ├── groovy/                     # 算子代码
│   │   └── ${operatorCode}.groovy
│   ├── method/                     # 类型为 METHOD 的库
│   │   └── ${fileName}
│   └── metainfo_operators.yml      # 元数据文件
```

#### Modern 模板（推荐新格式）

```
{包名}/
├── lib/                            # 所有公共库
│   └── ${libraryName}/
│       └── ${fileName}
├── operators/                       # 算子代码
│   └── ${operatorCode}/
│       └── ${fileName}
├── package.json
└── manifest.json
```

#### Custom 模板（完全自定义）

每个资源都可以单独配置自定义打包路径。

### 4.3 默认路径规则表

| 资源类型 | 库类型 | Legacy 模板路径 | Modern 模板路径 |
|---------|-------|----------------|----------------|
| 公共库 | CONSTANT | `operators/constants/${fileName}` | `lib/${libraryName}/${fileName}` |
| 公共库 | METHOD | `operators/method/${fileName}` | `lib/${libraryName}/${fileName}` |
| 公共库 | MODEL | `models/${fileName}` | `lib/${libraryName}/${fileName}` |
| 公共库 | CUSTOM | `lib/${libraryName}/${fileName}` | `lib/${libraryName}/${fileName}` |
| 算子代码 | - | `operators/groovy/${operatorCode}.groovy` | `operators/${operatorCode}/${fileName}` |

---

## 5. 功能需求

### 5.1 公共库管理

#### 5.1.1 创建公共库

**功能描述**：用户可以创建新的公共库，支持多文件定义。

**输入**：
- 公共库名称
- 描述
- 版本号
- 分类（可选）
- 库类型（CONSTANT/METHOD/MODEL/CUSTOM）
- 代码文件（可添加多个）

**输出**：公共库创建成功，包含初始版本 v1.0

**校验规则**：
- 名称不能为空，最大长度255
- 版本号不能为空
- 同一名称+版本不能重复

#### 5.1.2 编辑公共库基本信息

**功能描述**：用户可以编辑公共库的基本信息。

**操作**：
- 修改名称、描述、版本
- 修改分类、库类型

**校验规则**：
- 修改版本号时需要提示是否创建新版本

#### 5.1.3 公共库代码编辑

**功能描述**：提供独立的代码编辑器页面，支持多文件编辑和管理。

**页面路径**：`/libraries/{id}/code-editor`

**UI 布局**：VS Code 风格的左右布局
- 左侧：文件列表（支持切换、添加、删除、重命名）
- 右侧：代码编辑器（Monaco Editor）

**功能特性**：
1. **文件列表**：
   - 显示所有代码文件
   - 支持点击切换文件
   - 显示文件状态图标：
     - 🟢 已保存（CheckCircleOutlined）
     - 🟡 已修改未保存（EditOutlined）
     - 🔵 保存中（文字提示）
   - 显示文件字符数统计
   - 文件名旁有编辑图标（笔），点击可编辑文件名

2. **添加文件**：
   - 点击"添加文件"按钮弹出对话框
   - 用户输入文件名（如：`Example.groovy`）
   - 支持 Enter 键确认
   - 校验：文件名不能为空、不能重复

3. **编辑文件名**：
   - 点击文件名旁的编辑图标（笔）
   - 文件名变为可编辑输入框
   - 显示确认图标（勾号）
   - 支持按 Enter 键确认
   - 失焦自动保存
   - 校验：文件名不能为空、不能重复

4. **删除文件**：
   - 点击"删除"按钮
   - 二次确认后删除
   - 删除后重新加载库信息

5. **代码编辑器**：
   - 使用 Monaco Editor（VS Code 同款编辑器）
   - 支持 Groovy 语法高亮
   - 支持 Ctrl+S 快捷键保存
   - 显示当前文件状态（已修改/已保存）

6. **文件状态管理**：
   - `isDirty`：标记文件是否有未保存的修改
   - `isSaving`：标记文件是否正在保存
   - `originalCode`：保存从数据库读取的原始代码
   - 自动检测文件是否被修改（对比 currentCode vs originalCode）

7. **保存功能**：
   - 点击"保存"按钮或按 Ctrl+S
   - 只保存当前修改的文件（isDirty=true）
   - 保存成功后显示提示消息
   - 返回列表页时检查是否有未保存的文件

**路由配置**：
```typescript
<Route path="libraries">
  <Route index element={<LibraryListPage />} />
  <Route path=":id/code-editor" element={<LibraryCodeEditorPage />} />
</Route>
```

**技术实现**：
- 使用 `useRef` 解决 React 闭包问题，确保使用最新的文件索引
- 使用 `isUpdatingValueRef` 区分用户编辑和 setValue 触发的 onChange
- 文件列表和编辑器分离，左侧文件列表，右侧代码编辑器

**注意事项**：
- 当前实现未包含代码文件的版本管理
- 文件删除和重命名直接更新数据库
- 代码内容实时保存到前端状态，点击保存时提交到后端

#### 5.1.4 删除公共库

**功能描述**：删除公共库。

**校验规则**：
- 如果有算子正在使用该库，禁止删除并提示
- 如果有算子包正在使用该库，禁止删除并提示

### 5.2 算子引用公共库

#### 5.2.1 算子添加公共库依赖

**功能描述**：在编辑算子时，可以选择依赖的公共库。

**操作**：
- 在"公共库依赖"标签页选择公共库
- 显示已依赖的公共库列表
- 支持移除依赖

**注意**：算子不指定公共库版本，版本在算子包层面统一管理。

### 5.3 算子包配置

#### 5.3.1 选择打包模板

**功能描述**：用户可以选择打包模板（Legacy/Modern/Custom）。

**默认模板**：Legacy（兼容现有格式）

#### 5.3.2 配置算子打包路径

**功能描述**：为算子包中的每个算子配置打包路径。

**操作**：
- 显示推荐路径和当前路径
- 支持单个算子路径编辑
- 支持批量使用推荐路径
- 支持上移、下移调整顺序

**输入**：
- 是否使用自定义路径
- 自定义路径模板（支持变量）
- 顺序索引

#### 5.3.3 配置公共库打包路径

**功能描述**：为算子包中的每个公共库配置打包路径。

**操作**：
- 显示推荐路径和当前路径
- 支持单个库路径编辑
- 支持批量使用推荐路径
- 支持上移、下移调整顺序

**输入**：
- 是否使用自定义路径
- 自定义路径模板（支持变量）
- 顺序索引

### 5.4 打包预览

#### 5.4.1 查看打包结构预览

**功能描述**：实时查看打包后的目录结构。

**功能**：
- 以树形结构展示打包目录
- 标识文件来源（算子/库/元数据）
- 高亮显示使用自定义路径的资源

#### 5.4.2 冲突检测

**功能描述**：自动检测路径冲突和潜在问题。

**检测项**：
- 路径重复：同一路径被多个资源使用
- 依赖缺失：算子依赖的库未添加到包中
- 空包：算子包未添加任何算子

**提示**：
- 错误：路径冲突，阻止打包
- 警告：潜在问题，可以打包但需要关注

#### 5.4.3 刷新预览

**功能描述**：修改配置后可以刷新预览，无需保存。

**触发时机**：
- 切换打包模板
- 修改算子/库路径配置
- 添加/删除算子或库

---

## 6. API 接口设计

### 6.1 公共库管理接口

#### 6.1.1 创建公共库

```
POST /api/v1/libraries

Request Body:
{
  "name": "DateUtils",
  "description": "日期工具库",
  "version": "1.0",
  "category": "工具类",
  "libraryType": "METHOD",
  "files": [
    {
      "fileName": "DateUtils.groovy",
      "code": "public class DateUtils { ... }",
      "orderIndex": 0
    }
  ]
}

Response:
{
  "success": true,
  "message": "公共库创建成功",
  "data": {
    "id": 1,
    "name": "DateUtils",
    ...
  }
}
```

#### 6.1.2 更新公共库

```
PUT /api/v1/libraries/{id}

Request Body:
{
  "name": "DateUtils",
  "description": "日期工具库（更新版）",
  "version": "1.1",
  "files": [...]
}

Response:
{
  "success": true,
  "message": "公共库更新成功"
}
```

#### 6.1.3 删除公共库

```
DELETE /api/v1/libraries/{id}

Response:
{
  "success": true,
  "message": "公共库删除成功"
}
```

#### 6.1.4 查询公共库列表

```
GET /api/v1/libraries?page=1&size=10&keyword=Date

Response:
{
  "success": true,
  "data": {
    "total": 10,
    "page": 1,
    "size": 10,
    "items": [...]
  }
}
```

#### 6.1.5 创建库文件

```
POST /api/v1/libraries/{libraryId}/files

Request Body:
{
  "fileName": "DateUtils.groovy",
  "orderIndex": 0
}

Response:
{
  "success": true,
  "message": "文件创建成功",
  "data": {
    "id": 1,
    "fileName": "DateUtils.groovy",
    "code": "",
    "orderIndex": 0
  }
}
```

#### 6.1.6 更新库文件名

```
PUT /api/v1/libraries/{libraryId}/files/{fileId}

Request Body:
{
  "fileName": "NewName.groovy"
}

Response:
{
  "success": true,
  "message": "文件名更新成功"
}
```

#### 6.1.7 更新库文件内容

```
PUT /api/v1/libraries/{libraryId}/files/{fileId}/content

Request Body:
{
  "code": "public class DateUtils { ... }"
}

Response:
{
  "success": true,
  "message": "文件内容更新成功"
}
```

#### 6.1.8 删除库文件

```
DELETE /api/v1/libraries/{libraryId}/files/{fileId}

Response:
{
  "success": true,
  "message": "文件删除成功"
}
```

Response:
{
  "success": true,
  "data": {
    "total": 10,
    "page": 1,
    "size": 10,
    "items": [...]
  }
}
```

### 6.2 算子包配置接口

#### 6.2.1 获取打包配置

```
GET /api/v1/packages/{id}/path-config

Response:
{
  "success": true,
  "data": {
    "packageTemplate": "legacy",
    "operatorConfigs": [
      {
        "operatorId": 1,
        "operatorCode": "my_operator",
        "operatorName": "My Operator",
        "currentPath": "operators/groovy/my_operator.groovy",
        "recommendedPath": "operators/groovy/my_operator.groovy",
        "useCustomPath": false,
        "orderIndex": 0
      }
    ],
    "libraryConfigs": [
      {
        "libraryId": 1,
        "libraryName": "DateUtils",
        "libraryType": "METHOD",
        "version": "1.0",
        "currentPath": "operators/method/${fileName}",
        "recommendedPath": "operators/method/${fileName}",
        "useCustomPath": false,
        "orderIndex": 0
      }
    ]
  }
}
```

#### 6.2.2 更新算子路径配置

```
PUT /api/v1/packages/{id}/operators/{operatorId}/path-config

Request Body:
{
  "useCustomPath": true,
  "customPackagePath": "lib/custom/${operatorCode}.groovy",
  "orderIndex": 0
}

Response:
{
  "success": true,
  "message": "算子路径配置已更新"
}
```

#### 6.2.3 批量更新算子路径配置

```
PUT /api/v1/packages/{id}/operators/batch-path-config

Request Body:
{
  "useRecommendedPath": true,
  "operatorIds": [1, 2, 3, 4, 5]
}

Response:
{
  "success": true,
  "message": "已更新 5 个算子的路径配置"
}
```

#### 6.2.4 更新库路径配置

```
PUT /api/v1/packages/{id}/libraries/{libraryId}/path-config

Request Body:
{
  "useCustomPath": true,
  "customPackagePath": "lib/utils/${fileName}",
  "orderIndex": 0
}

Response:
{
  "success": true,
  "message": "库路径配置已更新"
}
```

#### 6.2.5 批量更新库路径配置

```
PUT /api/v1/packages/{id}/libraries/batch-path-config

Request Body:
{
  "useRecommendedPath": true,
  "libraryIds": [1, 2, 3]
}

Response:
{
  "success": true,
  "message": "已更新 3 个库的路径配置"
}
```

#### 6.2.6 更新算子包整体配置

```
PUT /api/v1/packages/{id}/config

Request Body:
{
  "packageTemplate": "legacy",
  "operatorConfigs": [
    {
      "operatorId": 1,
      "useCustomPath": false,
      "orderIndex": 0
    }
  ],
  "libraryConfigs": [
    {
      "libraryId": 1,
      "useCustomPath": false,
      "orderIndex": 0
    }
  ]
}

Response:
{
  "success": true,
  "message": "算子包配置已更新"
}
```

### 6.3 打包预览接口

#### 6.3.1 获取打包结构预览

```
GET /api/v1/packages/{id}/preview?template=legacy

Response:
{
  "success": true,
  "data": {
    "packageName": "my-business-package",
    "template": "legacy",
    "structure": [
      {
        "type": "directory",
        "path": "models",
        "children": []
      },
      {
        "type": "directory",
        "path": "operators",
        "children": [
          {
            "type": "directory",
            "path": "operators/constants",
            "children": [
              {
                "type": "file",
                "path": "operators/constants/const1.groovy",
                "source": {
                  "type": "library",
                  "id": 1,
                  "name": "CryptoConstants",
                  "version": "1.0"
                }
              }
            ]
          }
        ]
      }
    ],
    "conflicts": [],
    "warnings": ["算子 my_operator 依赖的公共库 DateUtils 未添加到包中"]
  }
}
```

---

## 7. 前端 UI 设计

### 7.1 公共库管理页面

```
┌─────────────────────────────────────────────────────────┐
│  公共库管理                          [新建公共库]      │
├─────────────────────────────────────────────────────────┤
│  搜索：[____________]  类型：[全部 ▼]  [搜索]          │
├─────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────┐ │
│  │ 📦 日期处理库                         v1.0       │ │
│  │    提供常用的日期格式化和计算函数                   │ │
│  │    类型：METHOD | 包含 3 个文件 | 5 个算子使用      │ │
│  │    [编辑信息] [编辑代码] [删除] [查看详情]           │
│  └───────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 7.2 公共库代码编辑器页面

```
┌───────────────────────────────────────────────────────────────────────┐
│  日期处理库 - 代码编辑          [返回列表]  [保存 (Ctrl+S)]   │
│  3 个文件 • 1 个未保存                                              │
├───────────────────────────────────────────────────────────────────────┤
│ ┌──────────┐ ┌─────────────────────────────────────────────────────┐ │
│ │ 文件列表 │ │ 📄 DateUtils.groovy  （已修改，未保存）        │ │
│ ├──────────┤ ├─────────────────────────────────────────────────────┤ │
│ │ [+添加   │ │                                                     │ │
│ │  文件]  │ │ public class DateUtils {                         │ │
│ ├──────────┤ │     // 格式化日期为 yyyy-MM-dd                  │ │
│ │文件列表： │ │     public static String formatDate(Date date) {    │ │
│ │🟢 DateUtils│ │         SimpleDateFormat sdf = new              │ │
│ │   234 字符│ │             SimpleDateFormat("yyyy-MM-dd");       │ │
│ │   [✏️删除] │ │         return sdf.format(date);                 │ │
│ ├──────────┤ │     }                                            │ │
│ │🟡 CommonM │ │ }                                               │ │
│ │ ethod     │ │                                                     │ │
│ │   156 字符│ │                                                     │ │
│ │   [✏️删除] │ │                                                     │ │
│ ├──────────┤ │                                                     │ │
│ │🔵 Utils   │ │                                                     │ │
│ │   保存中..│ │                                                     │ │
│ ├──────────┤ │                                                     │ │
│ │CustomUtil │ │                                                     │ │
│ │   89 字符 │ │                                                     │ │
│ │   [✏️删除] │ │                                                     │ │
│ └──────────┘ └─────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────────────┘
```

**文件列表说明**：
- 🟢 已保存（CheckCircleOutlined）
- 🟡 已修改未保存（EditOutlined）
- 🔵 保存中（文字提示）
- ✏️ 编辑文件名图标（EditOutlined，点击后变为输入框）
- 显示文件字符数统计

**添加文件说明**：
- 点击"添加文件"按钮弹出对话框
- 用户输入文件名（如：`Example.groovy`）
- 支持 Enter 键确认
- 校验：文件名不能为空、不能重复

**编辑文件名说明**：
- 点击文件名旁的编辑图标（笔）
- 文件名变为可编辑输入框
- 显示确认图标（勾号）
- 支持按 Enter 键确认
- 失焦自动保存
- 校验：文件名不能为空、不能重复

### 7.3 算子包编辑 - 打包配置

```
┌─────────────────────────────────────────────────────────┐
│  算子包 - 编辑                                          │
├─────────────────────────────────────────────────────────┤
│  基本信息 / 算子管理 / 公共库版本 / 打包配置            │
├─────────────────────────────────────────────────────────┤
│  打包配置                                                │
│                                                         │
│  选择打包模板：[Legacy ▼]  [刷新预览]                   │
│                                                         │
│  ─────────────────────────────────────────────────────   │
│                                                         │
│  打包结构预览：                                          │
│  ┌───────────────────────────────────────────────────┐ │
│  │ 📁 my-business-package/                         │ │
│  │   ├─ 📁 models/                                │ │
│  │   ├─ 📁 operators/                             │ │
│  │   │   ├─ 📁 constants/                        │ │
│  │   │   │   └─ 📄 const1.groovy                 │ │
│  │   │   ├─ 📁 groovy/                           │ │
│  │   │   │   ├─ 📄 operator1.groovy              │ │
│  │   │   │   └─ 📄 operator2.groovy              │ │
│  │   │   ├─ 📁 method/                           │ │
│  │   │   │   ├─ 📄 DateUtils.groovy              │ │
│  │   │   │   └─ 📄 CommonMethod.groovy          │ │
│  │   │   └─ 📄 metainfo_operators.yml           │ │
│  │   └─ 📁 lib/ (空)                            │ │
│  └───────────────────────────────────────────────────┘ │
│                                                         │
│  ⚠️ 检测到 1 个警告：                                   │
│    - 算子 my_operator 依赖的公共库 DateUtils 未添加到包中  │
│                                                         │
│  ─────────────────────────────────────────────────────   │
│                                                         │
│  算子打包路径：                               [批量配置]  │
│  ┌───────────────────────────────────────────────────┐ │
│  │ ⚙️ my_operator                          [编辑路径]  │ │
│  │    当前路径：operators/groovy/my_operator.groovy    │ │
│  │    [上移] [下移] [移除]                              │ │
│  └───────────────────────────────────────────────────┘ │
│                                                         │
│  公共库打包路径：                             [批量配置]  │
│  ┌───────────────────────────────────────────────────┐ │
│  │ 📦 DateUtils (v1.0)                            [编辑路径]  │ │
│  │    类型：METHOD | 当前路径：operators/method/${fileName} │ │
│  │    [上移] [下移] [移除]                              │ │
│  └───────────────────────────────────────────────────┘ │
│                                                         │
│  [保存] [取消]                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 8. 数据库迁移脚本

```sql
-- 公共库表
CREATE TABLE common_libraries (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    version VARCHAR(50) NOT NULL,
    category VARCHAR(100),
    library_type VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(100),
    updated_by VARCHAR(100)
);

-- 公共库文件表
CREATE TABLE common_library_files (
    id BIGSERIAL PRIMARY KEY,
    library_id BIGINT NOT NULL,
    file_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(500),
    code TEXT,
    order_index INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(100),
    updated_by VARCHAR(100),
    CONSTRAINT fk_library_file FOREIGN KEY (library_id)
        REFERENCES common_libraries(id) ON DELETE CASCADE
);

-- 算子-公共库关联表
CREATE TABLE operator_common_libraries (
    id BIGSERIAL PRIMARY KEY,
    operator_id BIGINT NOT NULL,
    library_id BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_op_common_library FOREIGN KEY (operator_id)
        REFERENCES operators(id) ON DELETE CASCADE,
    CONSTRAINT fk_library_operator FOREIGN KEY (library_id)
        REFERENCES common_libraries(id) ON DELETE CASCADE
);

-- 算子包-公共库关联表
CREATE TABLE package_common_libraries (
    id BIGSERIAL PRIMARY KEY,
    package_id BIGINT NOT NULL,
    library_id BIGINT NOT NULL,
    version VARCHAR(50) NOT NULL,
    order_index INTEGER,
    custom_package_path VARCHAR(500),
    use_custom_path BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_pkg_common_library FOREIGN KEY (package_id)
        REFERENCES operator_packages(id) ON DELETE CASCADE,
    CONSTRAINT fk_library_package FOREIGN KEY (library_id)
        REFERENCES common_libraries(id) ON DELETE CASCADE
);

-- 在现有 package_operators 表中增加字段
ALTER TABLE package_operators
    ADD COLUMN custom_package_path VARCHAR(500),
    ADD COLUMN use_custom_path BOOLEAN DEFAULT false;

-- 在现有 operator_packages 表中增加字段
ALTER TABLE operator_packages
    ADD COLUMN package_template VARCHAR(50) DEFAULT 'legacy';

-- 索引
CREATE INDEX idx_library_name ON common_libraries(name);
CREATE INDEX idx_library_version ON common_libraries(version);
CREATE INDEX idx_library_file_library ON common_library_files(library_id);
CREATE INDEX idx_op_common_library_op ON operator_common_libraries(operator_id);
CREATE INDEX idx_op_common_library_lib ON operator_common_libraries(library_id);
CREATE INDEX idx_pkg_common_library_pkg ON package_common_libraries(package_id);
CREATE INDEX idx_pkg_common_library_lib ON package_common_libraries(library_id);
CREATE INDEX idx_pkg_op_custom_path ON package_operators(custom_package_path);
CREATE INDEX idx_pkg_lib_custom_path ON package_common_libraries(custom_package_path);
```

---

## 9. 实施计划

### 阶段一：数据库和后端基础（Week 1-2）

1. 创建数据库表和迁移脚本
2. 创建实体类
3. 创建 Repository 接口
4. 创建 DTO 类

### 阶段二：后端 Service 层（Week 2-3）

1. 公共库 CRUD Service
2. 打包路径解析器（PackagePathResolver）
3. 打包预览服务（PackagePreviewService）
4. 算子包配置 Service

### 阶段三：后端 API 层（Week 3）

1. 公共库管理 API
2. 算子包配置 API
3. 打包预览 API

### 阶段四：前端开发（Week 4-5）

1. 公共库管理页面
2. 算子包编辑 - 打包配置标签页
3. 路径编辑弹窗
4. 批量配置弹窗
5. 打包预览组件

### 阶段五：测试和优化（Week 6）

1. 单元测试
2. 集成测试
3. UI 优化
4. 性能优化

---

## 10. 风险与注意事项

### 10.1 技术风险

1. **路径冲突检测**：需要确保冲突检测逻辑准确无误
2. **变量解析**：路径变量的解析需要完整测试
3. **向后兼容**：确保现有算子包格式不受影响

### 10.2 业务风险

1. **用户学习成本**：新的打包配置方式需要用户适应
2. **数据迁移**：现有数据可能需要迁移

### 10.3 注意事项

1. 本次不包含算子包导入功能，后续单独实施
2. 公共库预置常用库功能暂不实现
3. 路径预览功能需要实时响应，避免性能问题

---

## 11. 后续扩展方向

1. **公共库市场**：支持发布和订阅公共库
2. **公共库继承**：创建新库时基于现有库
3. **依赖分析**：可视化显示依赖关系图
4. **算子包导入**：支持导入现有算子包并解析配置
5. **版本约束**：支持语义化版本和版本范围

---

## 附录：相关文档

- [开发规范](../standards/development-conventions.md)
- [代码提交流程](../standards/code-submission-workflow.md)
- [算子基本信息扩展需求设计](./2026-02-20-算子基本信息扩展-需求设计.md)
- [算子业务逻辑字段](./2026-02-20-算子业务逻辑字段.md)

---

## 12. 实施状态（更新日期：2026-02-22）

### 12.1 已完成功能 ✅

#### 后端

**数据库**：
- ✅ V5__add_common_library_support.sql - 创建公共库相关表
- ✅ V6__fix_common_library_audit_fields.sql - 修复审计字段类型（BIGINT → VARCHAR(100)）

**实体类**：
- ✅ CommonLibrary.java - 公共库实体
- ✅ CommonLibraryFile.java - 公共库文件实体
- ✅ OperatorCommonLibrary.java - 算子-公共库关联实体
- ✅ PackageCommonLibrary.java - 算子包-公共库关联实体
- ✅ OperatorPackage.java - 添加 packageTemplate 字段
- ✅ PackageOperator.java - 添加 customPackagePath、useCustomPath 字段

**枚举**：
- ✅ LibraryType.java - 公共库类型枚举

**Repository**：
- ✅ CommonLibraryRepository
- ✅ CommonLibraryFileRepository
- ✅ OperatorCommonLibraryRepository
- ✅ PackageCommonLibraryRepository

**DTO**：
- ✅ LibraryRequest.java
- ✅ LibraryResponse.java
- ✅ LibraryFileCreateRequest.java
- ✅ LibraryFileRenameRequest.java
- ✅ LibraryFileContentUpdateRequest.java
- ✅ LibraryFileResponse.java
- ✅ LibrarySearchRequest.java
- ✅ OperatorPathConfigRequest/Response
- ✅ LibraryPathConfigRequest/Response
- ✅ PackagePathConfigRequest/Response
- ✅ AddLibraryToPackageRequest.java
- ✅ BatchPathConfigRequest.java
- ✅ PackagePreviewTreeNode.java
- ✅ PackagePreviewSource.java
- ✅ PackagePreviewConflict.java
- ✅ PackagePreviewResponse.java

**Service**：
- ✅ CommonLibraryService - 公共库 CRUD
- ✅ CommonLibraryServiceImpl - 公共库实现
- ✅ PackagePathResolver - 打包路径解析器
- ✅ PackagePreviewService - 打包预览服务
- ✅ PackageService - 扩展公共库相关方法

**Controller**：
- ✅ LibraryController - 公共库管理 API
  - ✅ POST /v1/libraries - 创建公共库
  - ✅ PUT /v1/libraries/{id} - 更新公共库
  - ✅ DELETE /v1/libraries/{id} - 删除公共库
  - ✅ GET /v1/libraries/{id} - 获取公共库详情
  - ✅ GET /v1/libraries - 搜索公共库
  - ✅ GET /v1/libraries/type/{type} - 按类型查询
  - ✅ GET /v1/libraries/category/{category} - 按分类查询
  - ✅ POST /v1/libraries/{libraryId}/files - 创建库文件
  - ✅ PUT /v1/libraries/{libraryId}/files/{fileId} - 更新库文件名
  - ✅ PUT /v1/libraries/{libraryId}/files/{fileId}/content - 更新库文件内容
  - ✅ DELETE /v1/libraries/{libraryId}/files/{fileId} - 删除库文件
- ✅ PackagePreviewController - 打包预览 API
- ✅ PackageController - 扩展公共库相关方法

**编译验证**：
- ✅ BUILD SUCCESS

#### 前端

**类型定义**（`operator-manager-web/src/types/library.ts`）：
- ✅ LibraryType - 枚举
- ✅ LibraryRequest
- ✅ LibraryResponse
- ✅ LibraryFileResponse
- ✅ LibrarySearchRequest
- ✅ 其他所有相关类型

**API 调用**（`operator-manager-web/src/api/library.ts`）：
- ✅ createLibrary() - 创建公共库
- ✅ updateLibrary() - 更新公共库
- ✅ deleteLibrary() - 删除公共库
- ✅ getLibraryById() - 获取公共库详情
- ✅ searchLibraries() - 搜索公共库
- ✅ getLibrariesByType() - 按类型查询
- ✅ getLibrariesByCategory() - 按分类查询
- ✅ createLibraryFile() - 创建库文件
- ✅ updateLibraryFileName() - 更新库文件名
- ✅ updateLibraryFileContent() - 更新库文件内容
- ✅ deleteLibraryFile() - 删除库文件

**页面**：
- ✅ list.tsx - 公共库列表页
  - ✅ 分页、搜索、类型过滤、分类过滤
  - ✅ 新建、编辑、删除公共库
  - ✅ "编辑代码"按钮跳转到代码编辑器
- ✅ code-editor.tsx - 公共库代码编辑器
  - ✅ VS Code 风格布局（左侧文件列表，右侧代码编辑器）
  - ✅ Monaco Editor 集成
  - ✅ 文件切换功能
  - ✅ 文件状态管理（isDirty、isSaving、originalCode）
  - ✅ 添加文件（弹出对话框输入文件名）
  - ✅ 删除文件
  - ✅ 编辑文件名（点击图标→输入框→保存）
  - ✅ 保存代码（Ctrl+S 快捷键）
  - ✅ 返回列表页时检查未保存文件

**组件**：
- ✅ CodeEditor.tsx - Monaco Editor 组件
  - ✅ 使用 isUpdatingValueRef 解决切换文件时误触发 onChange
  - ✅ 支持 Groovy 语法高亮

**路由配置**（`operator-manager-web/src/App.tsx`）：
- ✅ /libraries - 公共库列表
- ✅ /libraries/:id/code-editor - 公共库代码编辑器

**UI/UX 优化**：
- ✅ 使用 useRef 解决 React 闭包问题
- ✅ 文件名添加编辑图标（笔），点击可编辑
- ✅ 编辑状态下显示确认图标（勾号）
- ✅ 支持 Enter 键确认
- ✅ 失焦自动保存
- ✅ 文件名重复校验
- ✅ 添加文件时弹出对话框输入文件名

### 12.2 未完成功能 ⏳

#### 算子包配置（待实施）

- ❌ 算子包编辑页面 - 打包配置标签页
- ❌ 算子路径配置表格
- ❌ 公共库路径配置表格
- ❌ 批量配置弹窗
- ❌ 打包预览组件

#### 算子引用公共库（后端完成，前端待实施）

**后端（完成）：**
- ✅ DTO：AddLibraryDependencyRequest、LibraryDependencyResponse
- ✅ Service：OperatorService 添加公共库依赖相关方法
  - getOperatorLibraries() - 获取算子依赖的公共库列表
  - addLibraryDependency() - 添加公共库依赖
  - removeLibraryDependency() - 移除公共库依赖
- ✅ Controller：OperatorController 添加 API 接口
  - GET /v1/operators/{id}/library-dependencies - 获取算子依赖的公共库
  - POST /v1/operators/{id}/library-dependencies - 添加公共库依赖
  - DELETE /v1/operators/{id}/library-dependencies/{libraryId} - 移除公共库依赖
- ✅ 编译验证：BUILD SUCCESS
- ✅ 功能测试：所有测试通过

**前端（待实施）：**
- ❌ 算子编辑页面的"公共库依赖"标签页
- ❌ 选择/移除公共库依赖

#### 打包预览功能（待实施）

- ❌ 打包结构预览服务实现
- ❌ 冲突检测逻辑
- ❌ 路径变量解析

#### 前端待开发（待实施）

- ❌ 路径编辑弹窗（支持变量提示）
- ❌ 批量配置弹窗（算子/公共库）
- ❌ 树形结构预览组件

### 12.3 实施说明

1. **公共库基础管理**已完成
   - 公共库的 CRUD 功能
   - 公共库文件的管理（创建、删除、重命名、编辑内容）
   - 公共库的查询（分页、搜索、按类型、按分类）

2. **代码编辑器**已完成
   - VS Code 风格的代码编辑器
   - Monaco Editor 集成
   - 文件切换、状态管理、保存功能
   - 文件名编辑功能优化

3. **打包配置相关**后端已就绪，前端待开发
   - 后端 Service 层、API 层已完成
   - 前端需要开发打包配置页面和预览组件

4. **算子引用公共库**待开发
   - 需要在算子编辑页面添加公共库依赖选择功能

### 12.4 技术亮点

1. **React 状态管理**
   - 使用 `useRef` 解决闭包问题
   - 使用 `isUpdatingValueRef` 区分用户编辑和 setValue 触发
   - 准确追踪文件状态（isDirty、isSaving）

2. **Monaco Editor 集成**
   - 配置 Web Worker 避免警告
   - 支持 Groovy 语法高亮
   - 实时代码编辑和保存

3. **API 设计**
   - 分离库基本信息和文件管理
   - 提供细粒度的文件操作接口
   - 统一的响应格式

4. **数据库设计**
   - 审计字段类型优化（BIGINT → VARCHAR(100)）
   - 完整的外键约束和级联删除
