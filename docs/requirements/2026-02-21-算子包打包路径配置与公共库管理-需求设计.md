# 算子包打包路径配置与公共库管理 - 需求设计

> 创建日期：2026-02-21
> 版本：v1.0
> 状态：待实施

---

## 1. 需求背景

### 1.1 问题描述

当前算子管理系统中，算子之间存在一些公共代码逻辑（如常量、公共算法、公共数据模型等），这些代码需要在多个算子之间共享，并在打包时一起发布到算子包中。

同时，现有的算子包结构已经投入使用，新的系统设计需要保证兼容性，避免破坏现有算子包的使用。

### 1.2 目标

1. 支持公共代码库的创建和管理，实现算子之间的代码复用
2. 灵活的打包路径配置，支持兼容现有算子包格式
3. 提供打包结构预览和冲突检测，避免打包错误
4. 统一的包级配置管理，同一个算子可以在不同包中使用不同的打包路径

---

## 2. 核心设计思路

### 2.1 架构设计

```
┌─────────────────────────────────────────────────────────┐
│                   公共库（CommonLibrary）               │
│  - 纯粹的代码库定义，支持多文件                          │
│  - 不包含任何打包路径配置                                 │
└─────────────────────┬───────────────────────────────────┘
                      │ 引用（不指定版本）
                      ▼
              ┌───────────────┐
              │   算子       │
│  - 纯粹的算子代码定义                                      │
│  - 不包含任何打包路径配置                                     │
              └───────┬───────┘
                      │ 归属
                      ▼
┌─────────────────────────────────────────────────────────┐
│                  算子包                              │
│  - 统一管理所有资源的打包路径配置                            │
│  - 在关联表中存储版本和路径配置                             │
└─────────────────────────────────────────────────────────┘
```

### 2.2 核心原则

1. **算子和公共库解耦**：算子和公共库不包含打包路径配置，只包含纯粹的代码定义
2. **包级统一配置**：打包路径配置在算子包层面统一管理
3. **灵活复用**：同一个算子可以在不同包中使用不同的打包路径
4. **向后兼容**：支持现有的算子包格式（Legacy 模板）

---

## 3. 数据模型设计

### 3.1 CommonLibrary（公共库）

| 字段名 | 类型 | 说明 | 必填 |
|-------|------|------|-----|
| id | BIGINT | 主键 | 是 |
| name | VARCHAR(255) | 公共库名称 | 是 |
| description | TEXT | 描述 | 否 |
| version | VARCHAR(50) | 版本号 | 是 |
| category | VARCHAR(100) | 分类 | 否 |
| library_type | VARCHAR(50) | 库类型（CONSTANT/METHOD/MODEL/CUSTOM） | 是 |
| created_at | TIMESTAMP | 创建时间 | 是 |
| updated_at | TIMESTAMP | 更新时间 | 是 |
| created_by | BIGINT | 创建人 | 否 |

### 3.2 CommonLibraryFile（公共库文件）

| 字段名 | 类型 | 说明 | 必填 |
|-------|------|------|-----|
| id | BIGINT | 主键 | 是 |
| library_id | BIGINT | 公共库ID（外键） | 是 |
| file_name | VARCHAR(255) | 文件名 | 是 |
| file_path | VARCHAR(500) | MinIO存储路径 | 否 |
| code | TEXT | 代码内容 | 否 |
| order_index | INTEGER | 文件顺序 | 否 |
| created_at | TIMESTAMP | 创建时间 | 是 |
| updated_at | TIMESTAMP | 更新时间 | 是 |

### 3.3 Operator（算子）- 不变更

现有的算子实体无需变更，不包含打包路径配置。

### 3.4 OperatorPackage（算子包）- 增加字段

| 字段名 | 类型 | 说明 | 必填 |
|-------|------|------|-----|
| ... | ... | ... | ... |
| package_template | VARCHAR(50) | 打包模板（legacy/modern/custom） | 否 |

### 3.5 PackageOperator（算子包-算子关联）- 增加字段

| 字段名 | 类型 | 说明 | 必填 |
|-------|------|------|-----|
| ... | ... | ... | ... |
| custom_package_path | VARCHAR(500) | 自定义打包路径 | 否 |
| use_custom_path | BOOLEAN | 是否使用自定义路径 | 是 |

### 3.6 PackageCommonLibrary（算子包-公共库关联）- 增加字段

| 字段名 | 类型 | 说明 | 必填 |
|-------|------|------|-----|
| id | BIGINT | 主键 | 是 |
| package_id | BIGINT | 算子包ID（外键） | 是 |
| library_id | BIGINT | 公共库ID（外键） | 是 |
| version | VARCHAR(50) | 指定使用的版本 | 是 |
| order_index | INTEGER | 打包顺序 | 否 |
| custom_package_path | VARCHAR(500) | 自定义打包路径 | 否 |
| use_custom_path | BOOLEAN | 是否使用自定义路径 | 是 |
| created_at | TIMESTAMP | 创建时间 | 是 |
| updated_at | TIMESTAMP | 更新时间 | 是 |

---

## 4. 打包路径系统设计

### 4.1 路径变量

| 变量 | 说明 | 示例 |
|-----|------|-----|
| `${libraryName}` | 公共库名称 | `DateUtils` |
| `${libraryVersion}` | 公共库版本 | `1.0` |
| `${operatorCode}` | 算子编码 | `my_operator` |
| `${packageName}` | 算子包名称 | `my_package` |
| `${fileName}` | 文件名 | `DateUtils.js` |
| `${fileExt}` | 文件扩展名 | `.groovy` |

### 4.2 打包模板

#### Legacy 模板（兼容现有格式）

```
{包名}/
├── models/                          # 类型为 MODEL 的库
│   └── ${fileName}
├── operators/
│   ├── constants/                   # 类型为 CONSTANT 的库
│   │   └── ${fileName}
│   ├── groovy/                     # 算子代码
│   │   └── ${operatorCode}.groovy
│   ├── method/                     # 类型为 METHOD 的库
│   │   └── ${fileName}
│   └── metainfo_operators.yml      # 元数据文件
```

#### Modern 模板（推荐新格式）

```
{包名}/
├── lib/                            # 所有公共库
│   └── ${libraryName}/
│       └── ${fileName}
├── operators/                       # 算子代码
│   └── ${operatorCode}/
│       └── ${fileName}
├── package.json
└── manifest.json
```

#### Custom 模板（完全自定义）

每个资源都可以单独配置自定义打包路径。

### 4.3 默认路径规则表

| 资源类型 | 库类型 | Legacy 模板路径 | Modern 模板路径 |
|---------|-------|----------------|----------------|
| 公共库 | CONSTANT | `operators/constants/${fileName}` | `lib/${libraryName}/${fileName}` |
| 公共库 | METHOD | `operators/method/${fileName}` | `lib/${libraryName}/${fileName}` |
| 公共库 | MODEL | `models/${fileName}` | `lib/${libraryName}/${fileName}` |
| 公共库 | CUSTOM | `lib/${libraryName}/${fileName}` | `lib/${libraryName}/${fileName}` |
| 算子代码 | - | `operators/groovy/${operatorCode}.groovy` | `operators/${operatorCode}/${fileName}` |

---

## 5. 功能需求

### 5.1 公共库管理

#### 5.1.1 创建公共库

**功能描述**：用户可以创建新的公共库，支持多文件定义。

**输入**：
- 公共库名称
- 描述
- 版本号
- 分类（可选）
- 库类型（CONSTANT/METHOD/MODEL/CUSTOM）
- 代码文件（可添加多个）

**输出**：公共库创建成功，包含初始版本 v1.0

**校验规则**：
- 名称不能为空，最大长度255
- 版本号不能为空
- 同一名称+版本不能重复

#### 5.1.2 编辑公共库

**功能描述**：用户可以编辑公共库的基本信息和代码文件。

**操作**：
- 修改名称、描述、版本
- 添加/删除/修改代码文件
- 调整文件顺序

**校验规则**：
- 修改版本号时需要提示是否创建新版本
- 删除文件需要二次确认

#### 5.1.3 删除公共库

**功能描述**：删除公共库。

**校验规则**：
- 如果有算子正在使用该库，禁止删除并提示
- 如果有算子包正在使用该库，禁止删除并提示

### 5.2 算子引用公共库

#### 5.2.1 算子添加公共库依赖

**功能描述**：在编辑算子时，可以选择依赖的公共库。

**操作**：
- 在"公共库依赖"标签页选择公共库
- 显示已依赖的公共库列表
- 支持移除依赖

**注意**：算子不指定公共库版本，版本在算子包层面统一管理。

### 5.3 算子包配置

#### 5.3.1 选择打包模板

**功能描述**：用户可以选择打包模板（Legacy/Modern/Custom）。

**默认模板**：Legacy（兼容现有格式）

#### 5.3.2 配置算子打包路径

**功能描述**：为算子包中的每个算子配置打包路径。

**操作**：
- 显示推荐路径和当前路径
- 支持单个算子路径编辑
- 支持批量使用推荐路径
- 支持上移、下移调整顺序

**输入**：
- 是否使用自定义路径
- 自定义路径模板（支持变量）
- 顺序索引

#### 5.3.3 配置公共库打包路径

**功能描述**：为算子包中的每个公共库配置打包路径。

**操作**：
- 显示推荐路径和当前路径
- 支持单个库路径编辑
- 支持批量使用推荐路径
- 支持上移、下移调整顺序

**输入**：
- 是否使用自定义路径
- 自定义路径模板（支持变量）
- 顺序索引

### 5.4 打包预览

#### 5.4.1 查看打包结构预览

**功能描述**：实时查看打包后的目录结构。

**功能**：
- 以树形结构展示打包目录
- 标识文件来源（算子/库/元数据）
- 高亮显示使用自定义路径的资源

#### 5.4.2 冲突检测

**功能描述**：自动检测路径冲突和潜在问题。

**检测项**：
- 路径重复：同一路径被多个资源使用
- 依赖缺失：算子依赖的库未添加到包中
- 空包：算子包未添加任何算子

**提示**：
- 错误：路径冲突，阻止打包
- 警告：潜在问题，可以打包但需要关注

#### 5.4.3 刷新预览

**功能描述**：修改配置后可以刷新预览，无需保存。

**触发时机**：
- 切换打包模板
- 修改算子/库路径配置
- 添加/删除算子或库

---

## 6. API 接口设计

### 6.1 公共库管理接口

#### 6.1.1 创建公共库

```
POST /api/v1/libraries

Request Body:
{
  "name": "DateUtils",
  "description": "日期工具库",
  "version": "1.0",
  "category": "工具类",
  "libraryType": "METHOD",
  "files": [
    {
      "fileName": "DateUtils.groovy",
      "code": "public class DateUtils { ... }",
      "orderIndex": 0
    }
  ]
}

Response:
{
  "success": true,
  "message": "公共库创建成功",
  "data": {
    "id": 1,
    "name": "DateUtils",
    ...
  }
}
```

#### 6.1.2 更新公共库

```
PUT /api/v1/libraries/{id}

Request Body:
{
  "name": "DateUtils",
  "description": "日期工具库（更新版）",
  "version": "1.1",
  "files": [...]
}

Response:
{
  "success": true,
  "message": "公共库更新成功"
}
```

#### 6.1.3 删除公共库

```
DELETE /api/v1/libraries/{id}

Response:
{
  "success": true,
  "message": "公共库删除成功"
}
```

#### 6.1.4 查询公共库列表

```
GET /api/v1/libraries?page=1&size=10&keyword=Date

Response:
{
  "success": true,
  "data": {
    "total": 10,
    "page": 1,
    "size": 10,
    "items": [...]
  }
}
```

### 6.2 算子包配置接口

#### 6.2.1 获取打包配置

```
GET /api/v1/packages/{id}/path-config

Response:
{
  "success": true,
  "data": {
    "packageTemplate": "legacy",
    "operatorConfigs": [
      {
        "operatorId": 1,
        "operatorCode": "my_operator",
        "operatorName": "My Operator",
        "currentPath": "operators/groovy/my_operator.groovy",
        "recommendedPath": "operators/groovy/my_operator.groovy",
        "useCustomPath": false,
        "orderIndex": 0
      }
    ],
    "libraryConfigs": [
      {
        "libraryId": 1,
        "libraryName": "DateUtils",
        "libraryType": "METHOD",
        "version": "1.0",
        "currentPath": "operators/method/${fileName}",
        "recommendedPath": "operators/method/${fileName}",
        "useCustomPath": false,
        "orderIndex": 0
      }
    ]
  }
}
```

#### 6.2.2 更新算子路径配置

```
PUT /api/v1/packages/{id}/operators/{operatorId}/path-config

Request Body:
{
  "useCustomPath": true,
  "customPackagePath": "lib/custom/${operatorCode}.groovy",
  "orderIndex": 0
}

Response:
{
  "success": true,
  "message": "算子路径配置已更新"
}
```

#### 6.2.3 批量更新算子路径配置

```
PUT /api/v1/packages/{id}/operators/batch-path-config

Request Body:
{
  "useRecommendedPath": true,
  "operatorIds": [1, 2, 3, 4, 5]
}

Response:
{
  "success": true,
  "message": "已更新 5 个算子的路径配置"
}
```

#### 6.2.4 更新库路径配置

```
PUT /api/v1/packages/{id}/libraries/{libraryId}/path-config

Request Body:
{
  "useCustomPath": true,
  "customPackagePath": "lib/utils/${fileName}",
  "orderIndex": 0
}

Response:
{
  "success": true,
  "message": "库路径配置已更新"
}
```

#### 6.2.5 批量更新库路径配置

```
PUT /api/v1/packages/{id}/libraries/batch-path-config

Request Body:
{
  "useRecommendedPath": true,
  "libraryIds": [1, 2, 3]
}

Response:
{
  "success": true,
  "message": "已更新 3 个库的路径配置"
}
```

#### 6.2.6 更新算子包整体配置

```
PUT /api/v1/packages/{id}/config

Request Body:
{
  "packageTemplate": "legacy",
  "operatorConfigs": [
    {
      "operatorId": 1,
      "useCustomPath": false,
      "orderIndex": 0
    }
  ],
  "libraryConfigs": [
    {
      "libraryId": 1,
      "useCustomPath": false,
      "orderIndex": 0
    }
  ]
}

Response:
{
  "success": true,
  "message": "算子包配置已更新"
}
```

### 6.3 打包预览接口

#### 6.3.1 获取打包结构预览

```
GET /api/v1/packages/{id}/preview?template=legacy

Response:
{
  "success": true,
  "data": {
    "packageName": "my-business-package",
    "template": "legacy",
    "structure": [
      {
        "type": "directory",
        "path": "models",
        "children": []
      },
      {
        "type": "directory",
        "path": "operators",
        "children": [
          {
            "type": "directory",
            "path": "operators/constants",
            "children": [
              {
                "type": "file",
                "path": "operators/constants/const1.groovy",
                "source": {
                  "type": "library",
                  "id": 1,
                  "name": "CryptoConstants",
                  "version": "1.0"
                }
              }
            ]
          }
        ]
      }
    ],
    "conflicts": [],
    "warnings": ["算子 my_operator 依赖的公共库 DateUtils 未添加到包中"]
  }
}
```

---

## 7. 前端 UI 设计

### 7.1 公共库管理页面

```
┌─────────────────────────────────────────────────────────┐
│  公共库管理                          [新建公共库]      │
├─────────────────────────────────────────────────────────┤
│  搜索：[____________]  类型：[全部 ▼]  [搜索]          │
├─────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────┐ │
│  │ 📦 日期处理库                         v1.0       │ │
│  │    提供常用的日期格式化和计算函数                   │ │
│  │    类型：METHOD | 包含 3 个文件 | 5 个算子使用      │ │
│  │    [编辑] [删除] [查看详情]                        │ │
│  └───────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 7.2 算子包编辑 - 打包配置

```
┌─────────────────────────────────────────────────────────┐
│  算子包 - 编辑                                          │
├─────────────────────────────────────────────────────────┤
│  基本信息 / 算子管理 / 公共库版本 / 打包配置            │
├─────────────────────────────────────────────────────────┤
│  打包配置                                                │
│                                                         │
│  选择打包模板：[Legacy ▼]  [刷新预览]                   │
│                                                         │
│  ─────────────────────────────────────────────────────   │
│                                                         │
│  打包结构预览：                                          │
│  ┌───────────────────────────────────────────────────┐ │
│  │ 📁 my-business-package/                         │ │
│  │   ├─ 📁 models/                                │ │
│  │   ├─ 📁 operators/                             │ │
│  │   │   ├─ 📁 constants/                        │ │
│  │   │   │   └─ 📄 const1.groovy                 │ │
│  │   │   ├─ 📁 groovy/                           │ │
│  │   │   │   ├─ 📄 operator1.groovy              │ │
│  │   │   │   └─ 📄 operator2.groovy              │ │
│  │   │   ├─ 📁 method/                           │ │
│  │   │   │   ├─ 📄 DateUtils.groovy              │ │
│  │   │   │   └─ 📄 CommonMethod.groovy          │ │
│  │   │   └─ 📄 metainfo_operators.yml           │ │
│  │   └─ 📁 lib/ (空)                            │ │
│  └───────────────────────────────────────────────────┘ │
│                                                         │
│  ⚠️ 检测到 1 个警告：                                   │
│    - 算子 my_operator 依赖的公共库 DateUtils 未添加到包中  │
│                                                         │
│  ─────────────────────────────────────────────────────   │
│                                                         │
│  算子打包路径：                               [批量配置]  │
│  ┌───────────────────────────────────────────────────┐ │
│  │ ⚙️ my_operator                          [编辑路径]  │ │
│  │    当前路径：operators/groovy/my_operator.groovy    │ │
│  │    [上移] [下移] [移除]                              │ │
│  └───────────────────────────────────────────────────┘ │
│                                                         │
│  公共库打包路径：                             [批量配置]  │
│  ┌───────────────────────────────────────────────────┐ │
│  │ 📦 DateUtils (v1.0)                            [编辑路径]  │ │
│  │    类型：METHOD | 当前路径：operators/method/${fileName} │ │
│  │    [上移] [下移] [移除]                              │ │
│  └───────────────────────────────────────────────────┘ │
│                                                         │
│  [保存] [取消]                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 8. 数据库迁移脚本

```sql
-- 公共库表
CREATE TABLE common_libraries (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    version VARCHAR(50) NOT NULL,
    category VARCHAR(100),
    library_type VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by BIGINT
);

-- 公共库文件表
CREATE TABLE common_library_files (
    id BIGSERIAL PRIMARY KEY,
    library_id BIGINT NOT NULL,
    file_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(500),
    code TEXT,
    order_index INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by BIGINT,
    CONSTRAINT fk_library_file FOREIGN KEY (library_id)
        REFERENCES common_libraries(id) ON DELETE CASCADE
);

-- 算子-公共库关联表
CREATE TABLE operator_common_libraries (
    id BIGSERIAL PRIMARY KEY,
    operator_id BIGINT NOT NULL,
    library_id BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_op_common_library FOREIGN KEY (operator_id)
        REFERENCES operators(id) ON DELETE CASCADE,
    CONSTRAINT fk_library_operator FOREIGN KEY (library_id)
        REFERENCES common_libraries(id) ON DELETE CASCADE
);

-- 算子包-公共库关联表
CREATE TABLE package_common_libraries (
    id BIGSERIAL PRIMARY KEY,
    package_id BIGINT NOT NULL,
    library_id BIGINT NOT NULL,
    version VARCHAR(50) NOT NULL,
    order_index INTEGER,
    custom_package_path VARCHAR(500),
    use_custom_path BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_pkg_common_library FOREIGN KEY (package_id)
        REFERENCES operator_packages(id) ON DELETE CASCADE,
    CONSTRAINT fk_library_package FOREIGN KEY (library_id)
        REFERENCES common_libraries(id) ON DELETE CASCADE
);

-- 在现有 package_operators 表中增加字段
ALTER TABLE package_operators
    ADD COLUMN custom_package_path VARCHAR(500),
    ADD COLUMN use_custom_path BOOLEAN DEFAULT false;

-- 在现有 operator_packages 表中增加字段
ALTER TABLE operator_packages
    ADD COLUMN package_template VARCHAR(50) DEFAULT 'legacy';

-- 索引
CREATE INDEX idx_library_name ON common_libraries(name);
CREATE INDEX idx_library_version ON common_libraries(version);
CREATE INDEX idx_library_file_library ON common_library_files(library_id);
CREATE INDEX idx_op_common_library_op ON operator_common_libraries(operator_id);
CREATE INDEX idx_op_common_library_lib ON operator_common_libraries(library_id);
CREATE INDEX idx_pkg_common_library_pkg ON package_common_libraries(package_id);
CREATE INDEX idx_pkg_common_library_lib ON package_common_libraries(library_id);
CREATE INDEX idx_pkg_op_custom_path ON package_operators(custom_package_path);
CREATE INDEX idx_pkg_lib_custom_path ON package_common_libraries(custom_package_path);
```

---

## 9. 实施计划

### 阶段一：数据库和后端基础（Week 1-2）

1. 创建数据库表和迁移脚本
2. 创建实体类
3. 创建 Repository 接口
4. 创建 DTO 类

### 阶段二：后端 Service 层（Week 2-3）

1. 公共库 CRUD Service
2. 打包路径解析器（PackagePathResolver）
3. 打包预览服务（PackagePreviewService）
4. 算子包配置 Service

### 阶段三：后端 API 层（Week 3）

1. 公共库管理 API
2. 算子包配置 API
3. 打包预览 API

### 阶段四：前端开发（Week 4-5）

1. 公共库管理页面
2. 算子包编辑 - 打包配置标签页
3. 路径编辑弹窗
4. 批量配置弹窗
5. 打包预览组件

### 阶段五：测试和优化（Week 6）

1. 单元测试
2. 集成测试
3. UI 优化
4. 性能优化

---

## 10. 风险与注意事项

### 10.1 技术风险

1. **路径冲突检测**：需要确保冲突检测逻辑准确无误
2. **变量解析**：路径变量的解析需要完整测试
3. **向后兼容**：确保现有算子包格式不受影响

### 10.2 业务风险

1. **用户学习成本**：新的打包配置方式需要用户适应
2. **数据迁移**：现有数据可能需要迁移

### 10.3 注意事项

1. 本次不包含算子包导入功能，后续单独实施
2. 公共库预置常用库功能暂不实现
3. 路径预览功能需要实时响应，避免性能问题

---

## 11. 后续扩展方向

1. **公共库市场**：支持发布和订阅公共库
2. **公共库继承**：创建新库时基于现有库
3. **依赖分析**：可视化显示依赖关系图
4. **算子包导入**：支持导入现有算子包并解析配置
5. **版本约束**：支持语义化版本和版本范围

---

## 附录：相关文档

- [开发规范](../standards/development-conventions.md)
- [代码提交流程](../standards/code-submission-workflow.md)
- [算子基本信息扩展需求设计](./2026-02-20-算子基本信息扩展-需求设计.md)
- [算子业务逻辑字段](./2026-02-20-算子业务逻辑字段.md)
