# 算子包打包下载功能 - 需求设计文档

**文档版本**: v1.0
**创建日期**: 2026-02-23
**状态**: 待评审

---

## 1. 需求概述

### 1.1 需求背景

当前算子管理系统已经实现了算子包的创建、配置和预览功能，但缺少将算子包导出为可分发文件的能力。用户希望将配置好的算子包打包成压缩文件，下载到本地后，可以导入到运行态环境中使用。

### 1.2 需求目标

实现算子包的打包下载功能，让用户能够：
1. 在打包配置页面点击"打包下载"按钮
2. 后端生成包含算子代码、公共库文件和元数据信息的 ZIP 压缩包
3. 用户下载压缩包到本地
4. 压缩包可导入到运行态系统使用

### 1.3 原始需求记录

用户描述：
> 一个算子包，我们要增加一个打包下载的按钮，用户点击后，就能按照打包预览的样子将算子包中的算子、公共代码库、元数据信息生成为文件，并压缩为一个压缩包，让用户下载到本地，用户下载后就可以拿着算子包到运行态去导入。

核心业务诉求：
- 打包按钮的位置要合理
- 下载的压缩包结构与预览一致
- 元数据文件 metainfo_operators.yml 的内容根据算子包和算子信息生成

元数据文件结构要求：
```yaml
businessName: 取算子包的业务场景字段的值
version: 取算子包的版本号
operators:
  instances:  # 以下每一个数据对象就是一个算子的元数据信息
    - operator_code: 取算子的operator code
      name: 取算子的 name
      object_code: 取算子的object code
      data_format: 取算子的data format
      generator: 取算子的Generator
      order_no: 取算子在算子包中的order
```

---

## 2. 功能需求

### 2.1 功能描述

实现算子包打包下载功能，包括：

1. **前端功能**
   - 在算子包详情页面的「打包配置」标签页添加"打包下载"按钮
   - 按钮位置：打包模板选择的右侧，与"刷新预览"按钮并列
   - 点击后调用后端下载接口
   - 下载成功后显示提示信息

2. **后端功能**
   - 提供打包下载 API 接口
   - 根据算子包信息生成压缩包
   - 压缩包包含：算子代码文件、公共库文件、元数据文件
   - 元数据文件按照指定格式生成 YAML 内容
   - 返回 ZIP 格式的压缩包供下载

### 2.2 用户故事

**故事 1：下载算子包**
> 作为系统管理员，我希望能够将配置好的算子包下载为压缩文件，这样我就可以将算子包分发到运行态环境使用。

**验收标准：**
- 我可以在算子包详情页的「打包配置」标签页看到"打包下载"按钮
- 点击按钮后，浏览器开始下载 ZIP 压缩包
- 压缩包命名规范：`operator_package_{packageId}.zip`
- 压缩包结构与打包预览一致
- 压缩包包含 `metainfo_operators.yml` 元数据文件
- 元数据文件包含正确的算子包信息

### 2.3 功能清单

| 序号 | 功能点 | 描述 | 优先级 |
|------|--------|------|--------|
| 1 | 后端打包下载服务 | 实现 PackageBuildService，生成 ZIP 压缩包 | 高 |
| 2 | 元数据文件生成 | 生成符合规范的 YAML 格式元数据文件 | 高 |
| 3 | 打包下载 API | 提供 GET /packages/{id}/download 接口 | 高 |
| 4 | 前端 API 方法 | 实现 downloadPackage 方法，处理 blob 响应 | 中 |
| 5 | 前端下载按钮 | 在打包配置标签页添加"打包下载"按钮 | 中 |
| 6 | 下载成功提示 | 下载成功后显示提示信息 | 低 |

---

## 3. 非功能需求

### 3.1 性能要求

| 指标 | 要求 |
|------|------|
| API 响应时间 | < 10秒（中等规模算子包，包含 10 个算子和 5 个公共库）|
| 压缩包大小 | 取决于算子包规模，需要支持较大的压缩包 |
| 内存占用 | 使用流式处理，避免一次性加载大文件到内存 |

### 3.2 安全要求

- 仅已登录用户可以下载算子包
- 用户只能下载有权限的算子包
- 文件下载需要进行身份验证

### 3.3 可用性要求

- 压缩包结构清晰，易于解压和理解
- 元数据文件格式规范，便于运行态解析
- 下载失败时给出明确的错误提示

---

## 4. 技术方案

### 4.1 整体设计

**技术架构：**
```
前端 (React + TypeScript)
    ↓
    HTTP GET /packages/{id}/download
    ↓
后端 (Spring Boot + Java 21)
    ↓
    PackageBuildService (打包构建服务)
    ↓
    ZIP 压缩包生成
    ↓
    返回文件流供下载
```

**技术选型：**

| 层级 | 技术选型 | 说明 |
|--------|----------|------|
| 压缩库 | Zip4j 2.11.5 | Java 平台流行的 ZIP 库 |
| YAML 生成 | 手动拼接字符串 | 简单场景，无需引入 SnakeYAML |
| 数据来源 | 数据库字段 | 算子代码和公共库代码直接从数据库字段读取 |

**设计决策：**

1. **按钮位置**：打包配置标签页，打包模板选择的右侧
   - 原因：与打包配置强关联，下载的文件就是预览的内容
   - 优势：上下文清晰，用户配置完后可直接下载

2. **文件存储**：数据库字段
   - 原因：当前系统算子代码直接存储在数据库 code 字段
   - 优势：直接读取，无需额外存储服务调用

3. **压缩格式**：ZIP
   - 原因：通用格式，跨平台兼容性好

### 4.2 数据库设计

本次需求**不涉及**数据库表结构变更。

使用现有表：
- `operator_packages` - 算子包基本信息
- `package_operators` - 算子包-算子关联
- `operators` - 算子基本信息（包含代码字段）
- `package_common_libraries` - 算子包-公共库关联
- `common_libraries` - 公共库基本信息
- `common_library_files` - 公共库文件（包含代码字段）

### 4.3 接口设计

#### API 接口

**接口名称：下载算子包**

| 项目 | 说明 |
|------|------|
| **请求方式** | GET |
| **请求路径** | `/v1/packages/{id}/download` |
| **请求参数** | `id` - 算子包 ID（路径参数）|
| **权限要求** | 需要认证 (`@PreAuthorize("isAuthenticated()")`) |
| **响应格式** | `application/zip` (二进制文件流) |
| **响应头** | `Content-Disposition: attachment; filename="operator_package_{name}.zip"` |

**请求示例：**
```http
GET /api/v1/packages/13/download
Authorization: Bearer {token}
```

**响应示例：**
```
HTTP/1.1 200 OK
Content-Type: application/zip
Content-Disposition: attachment; filename="operator_package_13.zip"

[二进制数据流]
```

**错误响应：**
- `401` - 未认证
- `404` - 算子包不存在
- `500` - 服务器内部错误

#### DTO 设计

**OperatorMetadata.java** - 算子元数据
```java
package com.operator.common.dto.library;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * 算子元数据 DTO
 * 用于生成 metainfo_operators.yml 文件
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class OperatorMetadata {
    /**
     * 算子编码
     */
    private String operatorCode;

    /**
     * 算子名称
     */
    private String name;

    /**
     * 对象编码
     */
    private String objectCode;

    /**
     * 数据格式
     */
    private String dataFormat;

    /**
     * 生成方式
     */
    private String generator;

    /**
     * 在包中的顺序
     */
    private Integer orderNo;
}
```

**PackageMetadata.java** - 算子包元数据
```java
package com.operator.common.dto.library;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

/**
 * 算子包元数据 DTO
 * 用于生成 metainfo_operators.yml 文件
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class PackageMetadata {
    /**
     * 业务场景
     */
    private String businessName;

    /**
     * 算子包版本
     */
    private String version;

    /**
     * 算子列表
     */
    private List<OperatorMetadata> operators;
}
```

### 4.4 前端设计

#### API 客户端

**文件位置：** `operator-manager-web/src/api/package.ts`

```typescript
/**
 * 下载算子包
 * @param packageId 算子包 ID
 */
export const downloadPackage = async (packageId: number, packageName: string): Promise<void> => {
  try {
    const response = await api.request({
      url: `/packages/${packageId}/download`,
      method: 'GET',
      responseType: 'blob', // 重要：指定为 blob 类型
    });

    // 创建下载链接
    const url = window.URL.createObjectURL(new Blob([response]));
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', `operator_package_${packageName}.zip`);
    document.body.appendChild(link);
    link.click();

    // 清理
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);

    message.success('算子包下载成功');
  } catch (error: any) {
    throw error;
  }
};
```

#### 页面修改

**文件位置：** `operator-manager-web/src/pages/package/detail.tsx`

**修改位置 1：添加图标导入**
```typescript
import { DownloadOutlined } from '@ant-design/icons';
```

**修改位置 2：添加处理函数**
```typescript
const handleDownloadPackage = async () => {
  if (!id) return;
  try {
    await packageApi.downloadPackage(Number(id));
  } catch (error: any) {
    message.error(error.message || '下载算子包失败');
  }
};
```

**修改位置 3：添加下载按钮**

在「打包模板」卡片中添加打包下载按钮：
```typescript
<Card size="small" title="打包模板">
  <Row gutter={16} align="middle">
    <Col span={8}>
      <Text>当前模板：</Text>
      <Tag style={{ marginLeft: 8 }} color={pathConfig?.packageTemplate === 'legacy' ? 'blue' : pathConfig?.packageTemplate === 'modern' ? 'green' : 'orange'}>
        {pathConfig?.packageTemplate?.toUpperCase()}
      </Tag>
    </Col>
    <Col span={16} style={{ textAlign: 'right' }}>
      <Space>
        <Button icon={<ReloadOutlined />} onClick={() => fetchPreview()}>
          刷新预览
        </Button>
        <Button
          type="primary"
          icon={<DownloadOutlined />}
          onClick={handleDownloadPackage}
        >
          打包下载
        </Button>
      </Space>
    </Col>
  </Row>
</Card>
```

### 4.5 压缩包结构设计

**Legacy 模板下的压缩包结构：**
```
{算子包名称}/
└── {算子包版本}/
    └── operators/
        ├── metainfo_operators.yml      # 元数据文件
        ├── groovy/                   # 算子代码（Legacy 模板）
        │   ├── {operatorCode1}.groovy
        │   └── {operatorCode2}.groovy
        ├── constants/                 # 常量库
        │   └── {constantFile}.groovy
        ├── method/                    # 方法库
        │   └── {methodFile}.groovy
        └── models/                    # 模型库
            └── {modelFile}.groovy
```

**元数据文件内容示例：**
```yaml
businessName: 数据清洗算子包
version: 1.0.0
operators:
  instances:
    - operator_code: data_cleaner
      name: 数据清洗算子
      object_code: OBJ001
      data_format: JSON
      generator: TEMPLATE
      order_no: 0
    - operator_code: data_validator
      name: 数据校验算子
      object_code: OBJ002
      data_format: XML
      generator: TEMPLATE
      order_no: 1
```

---

## 5. 实施计划

### 5.1 任务分解

#### 阶段一：后端基础设施（优先级高）

| 任务 | 描述 | 负责模块 |
|------|------|----------|
| 1.1 | 添加 Maven 依赖（Zip4j） | operator-common/pom.xml |
| 1.2 | 创建 OperatorMetadata DTO | operator-common |
| 1.3 | 创建 PackageMetadata DTO | operator-common |
| 1.4 | 创建 PackageBuildService | operator-service |
| 1.5 | 实现元数据文件生成逻辑 | PackageBuildService |
| 1.6 | 实现 ZIP 打包逻辑 | PackageBuildService |
| 1.7 | 创建 PackageBuildController | operator-api |
| 1.8 | 实现下载 API 接口 | PackageBuildController |
| 1.9 | 后端编译测试 | - |

#### 阶段二：前端集成（优先级中）

| 任务 | 描述 | 负责模块 |
|------|------|----------|
| 2.1 | 添加 downloadPackage API 方法 | operator-manager-web/src/api/package.ts |
| 2.2 | 添加 DownloadOutlined 图标导入 | operator-manager-web/src/pages/package/detail.tsx |
| 2.3 | 添加 handleDownloadPackage 函数 | operator-manager-web/src/pages/package/detail.tsx |
| 2.4 | 添加打包下载按钮 | operator-manager-web/src/pages/package/detail.tsx |
| 2.5 | 前端编译测试 | - |

#### 阶段三：测试和验证（优先级高）

| 任务 | 描述 | 负责模块 |
|------|------|----------|
| 3.1 | 后端编译验证 | - |
| 3.2 | 后端服务启动验证 | - |
| 3.3 | 后端 API 接口测试 | - |
| 3.4 | 下载压缩包内容验证 | - |
| 3.5 | 前端下载功能测试 | - |
| 3.6 | 边界条件测试 | - |

### 5.2 依赖关系

```
阶段一（后端基础设施）
    ├─> 1.1 添加 Maven 依赖
    ├─> 1.2 创建 OperatorMetadata DTO
    ├─> 1.3 创建 PackageMetadata DTO
    ├─> 1.4 创建 PackageBuildService
    ├─> 1.5 实现元数据文件生成逻辑
    ├─> 1.6 实现 ZIP 打包逻辑
    ├─> 1.7 创建 PackageBuildController
    └─> 1.8 实现下载 API 接口

阶段一完成后
    └─> 1.9 后端编译测试

阶段二（前端集成） - 依赖阶段一完成
    ├─> 2.1 添加 downloadPackage API 方法
    ├─> 2.2 添加 DownloadOutlined 图标导入
    ├─> 2.3 添加 handleDownloadPackage 函数
    ├─> 2.4 添加打包下载按钮
    └─> 2.5 前端编译测试

阶段三（测试和验证） - 依赖阶段二完成
    ├─> 3.1 后端编译验证
    ├─> 3.2 后端服务启动验证
    ├─> 3.3 后端 API 接口测试
    ├─> 3.4 下载压缩包内容验证
    ├─> 3.5 前端下载功能测试
    └─> 3.6 边界条件测试
```

### 5.3 风险评估

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| **R1：大文件内存占用** | 算子包包含大量文件时，可能占用过多内存 | 使用流式处理，及时关闭资源 |
| **R2：元数据格式错误** | YAML 格式生成不正确，导致运行态无法解析 | 严格按照需求格式生成，测试验证 |
| **R3：文件路径不一致** | 压缩包路径与预览不一致，导致用户困惑 | 复用现有的路径解析逻辑，保持一致性 |
| **R4：下载超时** | 大规模算子包下载时间过长 | 设置合理的超时时间，前端显示加载状态 |
| **R5：空包处理** | 算子包没有算子或公共库时，压缩包为空 | 提前检查并给出友好提示 |

---

## 6. 验收标准

### 6.1 功能验收

| 验收项 | 验收标准 | 验证方法 |
|--------|----------|---------|
| **A1：后端编译** | 后端代码编译通过，无错误 | `mvn clean install` |
| **A2：后端启动** | 后端服务启动成功，无异常 | 查看启动日志 |
| **A3：API 接口** | 下载接口返回正确响应 | 使用 curl 或 Postman 测试 |
| **A4：压缩包结构** | 压缩包结构与预览一致 | 解压 ZIP 检查目录结构 |
| **A5：元数据文件** | 元数据文件格式正确，内容完整 | 解压后查看 YAML 文件 |
| **A6：前端编译** | 前端代码编译通过 | `npm run build` |
| **A7：前端下载** | 点击按钮能正常下载压缩包，文件名使用算子包名称 | 浏览器中点击下载按钮 |
| **A8：下载成功提示** | 下载成功后显示成功提示 | 检查页面提示 |

### 6.2 测试用例

**测试用例 1：正常下载**
- 前置条件：存在包含 2 个算子和 1 个公共库的算子包
- 操作：点击"打包下载"按钮
- 预期结果：下载 ZIP 文件，文件结构正确，包含元数据文件

**测试用例 2：空包下载**
- 前置条件：存在但无算子的算子包
- 操作：点击"打包下载"按钮
- 预期结果：下载 ZIP 文件，只包含元数据文件（operators 列表为空）

**测试用例 3：无公共库包下载**
- 前置条件：存在但无公共库的算子包
- 操作：点击"打包下载"按钮
- 预期结果：下载 ZIP 文件，包含算子文件和元数据，不包含公共库文件

**测试用例 4：未认证访问**
- 前置条件：用户未登录
- 操作：直接访问下载接口
- 预期结果：返回 401 未认证错误

**测试用例 5：不存在的包**
- 前置条件：访问不存在的算子包 ID
- 操作：访问下载接口
- 预期结果：返回 404 错误

---

## 7. 附录

### 7.1 参考资料

| 资源 | 说明 |
|------|------|
| Zip4j 文档 | https://github.com/zip4j/zip4j |
| Ant Design Button 组件 | https://ant.design/components/button/ |
| Spring Boot 文件下载 | https://www.baeldung.com/spring-download-file-in-browser |

### 7.2 变更记录

| 版本 | 日期 | 变更内容 | 修改人 |
|------|------|----------|--------|
| v1.0 | 2026-02-23 | 初始版本 | Claude AI Assistant |
