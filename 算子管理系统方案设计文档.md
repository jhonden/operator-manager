# 代码算子管理系统方案设计文档

## 1. 项目概述

### 1.1 项目背景

本项目旨在从零开始开发一个代码算子管理系统，专注于管理算子的完整生命周期。系统不负责算子的运行时执行，而是提供算子的注册、配置、版本管理、发布分发等全生命周期管理能力。

### 1.2 核心职责

**包含的功能**：
- 算子生命周期管理（创建、配置、版本、发布）
- 算子包管理（组合多个算子完成业务场景，支持执行顺序配置）
- 算子发布管理（发布到本地文件或REST接口目的地）
- 算子市场（搜索、评分、评论、下载）

**不包含的功能**：
- 算子的运行时执行
- 算子的沙箱隔离
- 算子的实际调度和执行

### 1.3 目标用户规模

个人/小团队（<100人）

## 2. 技术架构

### 2.1 技术栈选型

#### 后端技术栈

- **后端框架**: Spring Boot 3.2.x + JDK 21 LTS
- **算子语言支持**: Java + Groovy 4.x (仅用于代码元数据管理，不执行)
- **数据库**: PostgreSQL 15+ (主数据库，支持JSONB全文搜索)
- **缓存**: Redis 7.x (缓存)
- **文件存储**: MinIO (对象存储，S3兼容，用于算子文件存储)
- **认证**: Spring Security + JWT
- **HTTP客户端**: RestTemplate / WebClient (用于算子发布到REST接口)
- **构建工具**: Maven 3.9.x

#### 前端技术栈

- **框架**: Vue 3.x + TypeScript 5.x
- **构建工具**: Vite 5.x
- **UI组件库**: Element Plus / Ant Design Vue (业界成熟的Vue组件库)
- **状态管理**: Pinia (Vue 3官方推荐)
- **路由**: Vue Router 4.x
- **HTTP客户端**: Axios
- **表单处理**: VeeValidate / Element Plus Form
- **代码编辑器**: Monaco Editor (VS Code内核，支持Java/Groovy高亮)
- **图表**: ECharts (数据可视化)
- **样式方案**: Tailwind CSS / SCSS

### 2.2 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                     前端 (Vue 3 + TypeScript)                   │
│              Element Plus / Ant Design Vue                    │
└─────────────────────────────────────────────────────────────┘
                              ↓ HTTP/WebSocket
┌─────────────────────────────────────────────────────────────┐
│                  API Gateway Layer                        │
│              (REST API + 统一响应格式)                    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     Application Layer                     │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │ Operator    │ │ Package      │ │ Market      │ │
│  │ Management  │ │ Management   │ │ Service     │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     Domain Layer                          │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │ Operator    │ │ Package      │ │ Market      │ │
│  │ Domain      │ │ Domain       │ │ Domain      │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                  Infrastructure Layer                    │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │ Storage     │ │ Publisher    │ │ Git         │ │
│  │ Service     │ │ Service      │ │ Integration  │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     Data Layer                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │ PostgreSQL  │ │ Redis        │ │ MinIO       │ │
│  │ (主数据库)  │ │ (缓存)       │ │ (文件)      │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 3. 核心模块划分

### 3.1 后端模块

```
operator-manager/
├── operator-api/              # API层（Spring Boot启动模块）
├── operator-core/              # 核心领域模块
│   ├── operator-domain/        # 算子领域模型
│   ├── package-domain/         # 算子包领域模型
│   ├── version-domain/         # 版本领域模型
│   ├── publish-domain/         # 发布领域模型
│   └── market-domain/          # 市场领域模型
├── operator-service/           # 业务服务层
│   ├── operator/               # 算子服务
│   ├── package/                # 算子包服务
│   ├── version/                # 版本服务
│   ├── publish/                # 发布服务
│   └── market/                 # 市场服务
├── operator-infrastructure/    # 基础设施层
│   ├── storage/                # 存储服务（MinIO）
│   ├── publisher/              # 发布器（文件/REST接口）
│   │   ├── file-publisher/      # 文件发布器
│   │   └── rest-publisher/      # REST接口发布器
│   └── git/                   # Git集成
└── operator-common/            # 公共模块
    ├── security/               # 安全组件
    ├── utils/                  # 工具类
    └── exception/              # 异常定义
```

### 3.2 前端模块

```
operator-manager-web/
├── src/
│   ├── api/                   # API请求层
│   │   ├── auth.ts            # 认证相关API
│   │   ├── operator.ts        # 算子相关API
│   │   ├── package.ts         # 算子包相关API
│   │   ├── version.ts         # 版本相关API
│   │   ├── publish.ts         # 发布相关API
│   │   └── market.ts         # 市场相关API
│   ├── views/                 # 页面组件（Vue 3风格）
│   │   ├── auth/             # 认证相关页面
│   │   ├── dashboard/        # 仪表盘
│   │   ├── operator/          # 算子管理
│   │   ├── package/           # 算子包管理
│   │   ├── version/          # 版本管理
│   │   ├── publish/          # 发布管理
│   │   ├── market/           # 算子市场
│   │   └── user/             # 用户管理
│   ├── components/            # 公共组件
│   │   ├── common/           # 通用组件
│   │   ├── operator/         # 算子相关组件
│   │   ├── package/          # 算子包相关组件
│   │   └── market/          # 市场相关组件
│   ├── stores/               # 状态管理（Pinia）
│   ├── composables/          # Vue 3 组合式函数
│   ├── types/                # TypeScript类型定义
│   ├── utils/                # 工具函数
│   ├── styles/               # 样式文件
│   └── App.vue              # 根组件
├── package.json
├── tsconfig.json
├── vite.config.ts
└── tailwind.config.js
```

## 4. 数据库模型设计

### 4.1 核心表结构

1. **users** - 用户表（认证授权）
2. **operator_packages** - 算子包表（业务场景组合）
3. **operators** - 算子表（核心实体）
4. **operator_parameters** - 算子参数表
5. **categories** - 分类表
6. **versions** - 版本表
7. **package_versions** - 算子包版本表
8. **package_operators** - 算子包与算子关联表（含顺序字段）
9. **publish_destinations** - 发布目的地表
10. **publish_history** - 发布历史表
11. **market_items** - 市场商品表（支持算子和算子包）
12. **ratings** - 评分表
13. **reviews** - 评论表
14. **operator_permissions** - 权限表
15. **audit_logs** - 审计日志表

### 4.2 package_operators表结构（含顺序字段）

```sql
CREATE TABLE package_operators (
    id UUID PRIMARY KEY,
    package_id UUID NOT NULL REFERENCES operator_packages(id),
    operator_id UUID NOT NULL REFERENCES operators(id),
    version_id UUID NOT NULL REFERENCES versions(id),
    order_index INTEGER NOT NULL DEFAULT 0,  -- 执行顺序字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(package_id, operator_id)
);

CREATE INDEX idx_package_operators_order ON package_operators(package_id, order_index);
```

## 5. 核心功能设计

### 5.1 算子管理

- 算子CRUD（创建、读取、更新、删除）
- 算子参数配置（输入参数、输出参数）
- 算子代码文件管理（支持.java、.groovy文件）
- 算子分类和标签管理
- 算子权限管理

### 5.2 算子包管理

- 算子包CRUD
- 算子包内的算子管理（添加、移除、排序）
  - **关键特性：支持算子执行顺序配置（order_index字段）**
- 算子包元数据管理（名称、描述、业务场景说明）
- 算子包版本管理

### 5.3 版本管理

- 版本创建
- 版本列表和详情
- 版本比较
- 版本回滚

### 5.4 发布管理（核心功能）

**发布目的地类型**：

1. **本地文件发布**
   - 将算子代码导出到本地文件系统
   - 支持压缩包格式（zip、tar.gz）
   - 支持单个算子文件导出

2. **REST接口发布**
   - 通过HTTP POST将算子发布到指定REST接口
   - 支持自定义请求头
   - 支持请求体模板配置
   - 支持发布结果记录

**发布配置**：
```java
public class PublishDestination {
    private String name;           // 发布目的地名称
    private DestinationType type;  // 类型：LOCAL_FILE, REST_API
    private String config;         // JSON配置

    // REST API配置示例
    // {
    //   "url": "https://api.example.com/operators",
    //   "method": "POST",
    //   "headers": {
    //     "Authorization": "Bearer {token}",
    //     "Content-Type": "application/json"
    //   },
    //   "bodyTemplate": {
    //     "operatorName": "${operatorName}",
    //     "version": "${version}",
    //     "code": "${base64Code}"
    //   }
    // }
}
```

### 5.5 算子市场

- 市场商品列表（支持算子和算子包）
- 商品详情展示
- 全文搜索（PostgreSQL to_tsvector）
- 评分和评论
- 商品下载/克隆

## 6. API设计

### 6.1 RESTful API

```
POST   /api/v1/operators                    # 创建算子
GET    /api/v1/operators                    # 获取算子列表
GET    /api/v1/operators/{id}               # 获取算子详情
PUT    /api/v1/operators/{id}               # 更新算子
DELETE /api/v1/operators/{id}               # 删除算子

POST   /api/v1/packages                     # 创建算子包
GET    /api/v1/packages                     # 获取算子包列表
GET    /api/v1/packages/{id}                # 获取算子包详情
PUT    /api/v1/packages/{id}                # 更新算子包
DELETE /api/v1/packages/{id}                # 删除算子包
POST   /api/v1/packages/{id}/operators      # 添加算子到包
PUT    /api/v1/packages/{id}/operators/{operatorId}/order  # 更新算子顺序
DELETE /api/v1/packages/{id}/operators/{operatorId}  # 从包中移除算子

POST   /api/v1/publish                       # 执行发布
GET    /api/v1/publish/destinations         # 获取发布目的地列表
GET    /api/v1/publish/history              # 获取发布历史

GET    /api/v1/versions                     # 获取版本列表
GET    /api/v1/versions/{id}                # 获取版本详情

GET    /api/v1/market/items                  # 获取市场商品列表
GET    /api/v1/market/search                  # 搜索商品
GET    /api/v1/market/items/{id}             # 获取商品详情
POST   /api/v1/market/items/{id}/rating     # 提交评分
POST   /api/v1/market/items/{id}/review     # 提交评论
```

## 7. 前端UI设计要点

### 7.1 整体布局

采用经典的左侧导航 + 顶部Header + 内容区的管理后台布局

### 7.2 核心页面

1. **仪表盘页面**
   - 统计卡片区（算子总数、算子包数、市场商品数等）
   - 图表区（ECharts图表）
   - 最近操作列表

2. **算子列表页面**
   - 表格布局（支持排序、筛选、分页）
   - 操作列（编辑、删除、发布）

3. **算子详情页面**
   - 基本信息展示
   - 参数配置展示
   - 版本历史
   - 快速操作（发布到市场、创建新版本）

4. **算子包列表页面**
   - 卡片式布局（3列网格）
   - 搜索和筛选

5. **算子包详情页面**
   - 算子包基本信息
   - 包含算子列表（支持拖拽排序）
   - 数据流转图展示

6. **发布配置页面**
   - 发布目的地配置表单
   - 发布历史记录
   - 发布状态展示

7. **算子市场页面**
   - 商品卡片网格
   - 搜索和筛选
   - 评分和评论展示

### 7.3 组件库

基于Element Plus / Ant Design Vue进行二次封装

## 8. 实施计划

### 阶段划分

| 阶段 | 里程碑 | 预计时间 | 关键指标 |
|------|--------|----------|----------|
| 1 | 后端基础框架搭建完成 | Week 3 | 项目可运行，基础API可用，JDK21集成完成 |
| 2 | 前端基础框架搭建完成 | Week 6 | 前端项目可运行，基础组件完成，认证功能完成 |
| 3 | 算子与算子包管理完成 | Week 11 | 算子CRUD、算子包管理、参数管理、权限控制（后端+前端） |
| 4 | 版本管理完成 | Week 15 | 版本控制、算子包版本、Git集成（后端+前端） |
| 5 | 发布管理完成 | Week 19 | 文件发布、REST接口发布、发布历史（后端+前端） |
| 6 | 算子与算子包市场完成 | Week 22 | 搜索、评分、评论功能（后端+前端） |
| 7 | 监控运维完成 | Week 25 | 监控、日志、审计系统（后端+前端） |
| 8 | 测试优化完成 | Week 28 | 测试覆盖率>80%（后端），性能达标 |
| 9 | 系统上线 | Week 30 | 生产环境运行正常 |

**总计：约7.5个月**

## 9. 技术要点

### 9.1 算子包顺序管理

算子包中的算子通过`order_index`字段指定执行顺序：

```java
@Entity
@Table(name = "package_operators")
public class PackageOperator {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @ManyToOne(fetch = FetchType.LAZY)
    private OperatorPackage package;

    @ManyToOne(fetch = FetchType.LAZY)
    private Operator operator;

    @ManyToOne(fetch = FetchType.LAZY)
    private Version version;

    @Column(name = "order_index", nullable = false)
    private Integer orderIndex = 0;  // 执行顺序，从0开始

    // 当用户在前端拖拽调整顺序后，批量更新orderIndex
    public static void reorder(List<PackageOperator> pos) {
        for (int i = 0; i < pos.size(); i++) {
            pos.get(i).setOrderIndex(i);
        }
    }
}
```

### 9.2 发布器设计

**文件发布器**：
```java
public class FilePublisher {
    public PublishResult publish(Operator operator, Version version, FileDestinationConfig config) {
        // 1. 从MinIO下载算子代码文件
        byte[] codeBytes = storageService.downloadFile(operator.getCodePath());

        // 2. 根据配置打包
        File packageFile = createPackage(operator, version, codeBytes, config);

        // 3. 写入目标路径
        Path targetPath = Paths.get(config.getTargetPath());
        Files.copy(packageFile.toPath(), targetPath, StandardCopyOption.REPLACE_EXISTING);

        // 4. 记录发布历史
        PublishHistory history = new PublishHistory(operator, version, config, true);
        publishHistoryRepository.save(history);

        return PublishResult.success(targetPath.toString());
    }
}
```

**REST接口发布器**：
```java
public class RestPublisher {
    public PublishResult publish(Operator operator, Version version, RestDestinationConfig config) {
        // 1. 准备请求数据
        Map<String, Object> requestBody = buildRequestBody(operator, version, config);

        // 2. 配置HTTP客户端
        WebClient client = WebClient.builder()
            .defaultHeaders(config.getHeaders())
            .build();

        // 3. 发送请求
        Mono<String> response = client.post()
            .uri(config.getUrl())
            .bodyValue(requestBody)
            .retrieve()
            .bodyToMono(String.class);

        // 4. 记录发布历史
        PublishHistory history = new PublishHistory(operator, version, config, true);
        publishHistoryRepository.save(history);

        return PublishResult.success(response.block());
    }
}
```

### 9.3 前端状态管理（Pinia）

```typescript
// stores/package.ts
export const usePackageStore = defineStore('package', {
  state: () => ({
    packages: [] as Package[],
    selectedPackage: null as Package | null,
    operators: [] as PackageOperator[],  // 包含顺序信息
  }),

  actions: {
    async fetchPackages() {
      const packages = await api.package.list();
      this.packages = packages;
    },

    async fetchOperators(packageId: string) {
      const operators = await api.package.operators(packageId);
      // 按order_index排序
      this.operators = operators.sort((a, b) => a.orderIndex - b.orderIndex);
    },

    async reorderOperators(packageId: string, operators: PackageOperator[]) {
      // 更新本地顺序
      operators.forEach((op, index) => op.orderIndex = index);

      // 调用API更新顺序
      await api.package.updateOrder(packageId, operators.map(op => ({
        operatorId: op.operatorId,
        orderIndex: op.orderIndex
      })));
    }
  }
});
```

## 10. 风险和应对

| 风险 | 应对策略 |
|------|----------|
| REST接口发布失败 | 记录详细错误信息，提供重试机制，支持断点续传 |
| 算子包顺序冲突 | 唯一性约束保证orderIndex不重复，提供自动重新编号功能 |
| 文件发布权限问题 | 提供权限校验，友好提示 |
| 前端状态管理复杂 | 使用Pinia统一管理，提供类型推断 |
| 性能问题 | 分页加载，虚拟滚动，缓存优化 |

## 11. 验证计划

### 功能验证

1. 创建算子并上传代码
2. 配置算子参数
3. 创建算子包
4. 向算子包添加算子并调整顺序
5. 创建算子包版本
6. 发布算子到本地文件
7. 发布算子到REST接口
8. 发布算子包到市场
9. 搜索算子和算子包
10. 提交评分和评论

### 性能验证

1. API响应时间 < 500ms
2. 全文搜索响应时间 < 100ms
3. 算子包算子列表加载时间 < 1s
4. 文件上传支持断点续传

### 安全验证

1. 权限控制验证
2. SQL注入测试
3. XSS攻击测试
4. 文件上传安全测试
5. REST接口发布目标验证

---

**文档版本**: v1.0
**最后更新**: 2025-01-15
**作者**: Claude AI Assistant
