# 代码算子管理系统方案设计文档

> **文档版本**: v2.0
> **最后更新**: 2026-02-19
> **作者**: Claude AI Assistant

## 1. 项目概述

### 1.1 项目背景

本项目旨在从零开始开发一个代码算子管理系统，专注于管理算子的完整生命周期。系统不负责算子的运行时执行，而是提供算子的注册、配置、版本管理、发布分发等全生命周期管理能力。

### 1.2 核心职责

**包含的功能**：
- 算子生命周期管理（创建、配置、版本、发布）
- 算子包管理（组合多个算子完成业务场景，支持执行顺序配置）
- 算子权限管理（RBAC 授权）
- 审计日志系统

**不包含的功能**：
- 算子的运行时执行
- 算子的沙箱隔离
- 算子的实际调度和执行
- 分类系统（Category）- 已从设计中移除
- 标签系统（Tags）- 已从设计中移除
- 算子市场（Market）- 暂未实现
- 发布管理（Publish）- 暂未实现
- 版本管理（Version）- 暂未实现

### 1.3 目标用户规模

个人/小团队（<100人）

## 2. 技术架构

### 2.1 技术栈选型

#### 后端技术栈

- **后端框架**: Spring Boot 3.2.x + JDK 21 LTS
- **算子语言支持**: Java + Groovy 4.x（仅用于代码元数据管理，不执行）
- **数据库**: PostgreSQL 15+（主数据库，支持 JSONB 全文搜索）
- **缓存**: Redis 7.x（缓存和队列）
- **文件存储**: MinIO（对象存储，S3 兼容，用于算子文件存储）
- **认证**: Spring Security + JWT
- **HTTP客户端**: RestTemplate（用于算子发布到 REST 接口）
- **构建工具**: Maven 3.9.x

#### 前端技术栈

- **框架**: React 18 + TypeScript 5.x
- **构建工具**: Vite 5.x
- **UI组件库**: Ant Design 5.x（业界成熟的 React 组件库）
- **状态管理**: Zustand（轻量级 React 状态管理）
- **路由**: React Router 6.x
- **HTTP客户端**: Axios
- **表单处理**: Ant Design Form
- **代码编辑器**: Monaco Editor（VS Code 内核，支持 Java/Groovy 高亮）
- **图表**: ECharts（数据可视化）

### 2.2 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                     前端 (React 18 + TypeScript)         │
│              Ant Design 5.x                          │
└─────────────────────────────────────────────────────────────┘
                              ↓ HTTP/WebSocket
┌─────────────────────────────────────────────────────────────┐
│                  API Gateway Layer                        │
│              (REST API + 统一响应格式)                    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     Application Layer                     │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │ Operator    │ │ Package      │ │ Auth        │ │
│  │ Management  │ │ Management   │ │ Service     │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                  Domain Layer                          │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │ Operator    │ │ Package      │ │ User/Security │ │
│  │ Domain      │ │ Domain       │ │ Domain       │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                  Infrastructure Layer                    │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌───────────┐ │
│  │ Storage     │ │ Publisher    │ │ Git        │ │ Redis    │ │
│  │ Service     │ │ Service      │ │ Integration  │ │ (Cache)   │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └───────────┘ │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     Data Layer                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │ PostgreSQL  │ │ Redis        │ │ MinIO       │ │
│  │ (主数据库)  │ │ (缓存)       │ │ (文件)      │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 3. 核心模块划分

### 3.1 后端模块

```
operator-manager/
├── operator-api/              # API 层（Spring Boot 启动模块）
├── operator-core/              # 核心领域模块
│   ├── operator-domain/        # 算子领域模型
│   ├── package-domain/         # 算子包领域模型
│   ├── publish-domain/         # 发布领域模型（暂未完全实现）
│   ├── version-domain/         # 版本领域模型（暂未完全实现）
│   ├── security-domain/         # 安全领域模型
│   └── audit-domain/          # 审计领域模型
├── operator-service/           # 业务服务层
│   ├── operator/               # 算子服务
│   ├── package/                # 算子包服务
│   ├── security/               # 安全服务
│   └── user/                  # 用户服务
├── operator-infrastructure/    # 基础设施层
│   ├── storage/                # 存储服务（MinIO）
│   ├── publisher/              # 发布器（文件发布器，暂未完全集成）
│   ├── git/                   # Git 集成（暂未完全实现）
│   └── cache/                 # 缓存服务（Redis）
└── operator-common/            # 公共模块
    ├── security/               # 安全组件（JWT、Filter）
    ├── utils/                  # 工具类
    ├── exception/              # 异常定义
    └── dto/                   # 通用数据传输对象
```

### 3.2 前端模块

```
operator-manager-web/
├── src/
│   ├── api/                   # API 请求层
│   │   ├── auth.ts            # 认证相关 API
│   │   ├── operator.ts        # 算子相关 API
│   │   ├── package.ts         # 算子包相关 API
│   │   └── user.ts            # 用户相关 API
│   ├── pages/                 # 页面组件
│   │   ├── auth/             # 认证相关页面
│   │   │   ├── login.tsx
│   │   │   └── register.tsx
│   │   ├── operator/          # 算子管理
│   │   │   ├── list.tsx
│   │   │   ├── create.tsx
│   │   │   └── detail.tsx
│   │   ├── package/           # 算子包管理
│   │   │   ├── list.tsx
│   │   │   ├── create.tsx
│   │   │   └── detail.tsx
│   │   └── execution/        # 执行监控
│   │       └── task-detail.tsx
│   ├── components/            # 公共组件
│   │   ├── common/           # 通用组件
│   │   │   ├── Layout.tsx
│   │   │   ├── Header.tsx
│   │   │   └── Sidebar.tsx
│   │   ├── operator/         # 算子相关组件
│   │   │   ├── ParameterForm.tsx
│   │   │   └── CodeEditor.tsx
│   │   └── execution/        # 执行相关组件
│   ├── stores/               # 状态管理（Zustand）
│   │   ├── useAuthStore.ts
│   │   └── useTaskLogs.ts
│   ├── hooks/                # 自定义 Hooks
│   │   ├── useWebSocket.ts
│   │   └── useTaskLogs.ts
│   ├── types/                # TypeScript 类型定义
│   ├── utils/                # 工具函数
│   └── App.tsx              # 根组件
├── package.json
├── tsconfig.json
├── vite.config.ts
└── tailwind.config.js
```

## 4. 数据库模型设计

### 4.1 核心表结构

**已实现的核心表**：

1. **users** - 用户表（认证授权）
2. **operator_packages** - 算子包表（业务场景组合）
3. **operators** - 算子表（核心实体）
4. **operator_parameters** - 算子参数表
5. **package_operators** - 算子包与算子关联表（含顺序字段）
6. **operator_permissions** - 权限表
7. **audit_logs** - 审计日志表
8. **publish_destinations** - 发布目的地表（暂未完全实现）
9. **publish_history** - 发布历史表（暂未完全实现）

**暂未完全实现的表**：
- **versions** - 版本表（domain 定义存在但未完全实现）
- **categories** - 分类表（已从设计中移除）
- **market_items** - 市场商品表（未实现）
- **ratings** - 评分表（未实现）
- **reviews** - 评论表（未实现）
- **operator_tags** - 算子标签表（已从设计中移除）
- **package_tags** - 算子包标签表（已从设计中移除）

### 4.2 package_operators 表结构（含顺序字段）

```sql
CREATE TABLE package_operators (
    id UUID PRIMARY KEY,
    package_id UUID NOT NULL REFERENCES operator_packages(id),
    operator_id UUID NOT NULL REFERENCES operators(id),
    version_id UUID REFERENCES versions(id),  -- 版本关联
    order_index INTEGER NOT NULL DEFAULT 0,  -- 执行顺序字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(package_id, operator_id)
);

CREATE INDEX idx_package_operators_order ON package_operators(package_id, order_index);
```

## 5. 核心功能设计

### 5.1 算子管理

- 算子 CRUD（创建、读取、更新、删除）
- 算子参数配置（输入参数、输出参数）
- 算子代码文件管理（支持 .java、.groovy 文件）
- 算子权限管理
- 算子上传/下载

### 5.2 算子包管理

- 算子包 CRUD
- 算子包内的算子管理（添加、移除、排序）
- 算子包元数据管理（名称、描述、业务场景说明）
- 算子包版本管理
- **关键特性**：支持算子执行顺序配置（order_index 字段）

### 5.3 发布管理（暂未完全实现）

**发布目的地类型**：

1. **本地文件发布**
   - 将算子代码导出到本地文件系统
   - 支持压缩包格式（zip、tar.gz）
   - 支持单个算子文件导出

2. **REST 接口发布**
   - 通过 HTTP POST 将算子发布到指定 REST 接口
   - 支持自定义请求头
   - 支持请求体模板配置

**发布配置**：
```java
public class PublishDestination {
    private String name;           // 发布目的地名称
    private DestinationType type;  // 类型：LOCAL_FILE, REST_API
    private String config;         // JSON 配置

    // REST API 配置示例
    // {
    //   "url": "https://api.example.com/operators",
    //   "method": "POST",
    //   "headers": {
    //     "Authorization": "Bearer {token}",
    //     "Content-Type": "application/json"
    //   },
    //   "bodyTemplate": {
    //     "operatorName": "${operatorName}",
    //     "version": "${version}",
    //     "code": "${base64Code}"
    //   }
    // }
}
```

### 5.4 版本管理（暂未完全实现）

- 版本创建
- 版本列表和详情
- 版本比较（待评估）
- 版本回滚（待评估）

### 5.5 市场功能（未实现）

市场功能暂未实现，设计保留供未来参考：
- 市场商品列表（支持算子和算子包）
- 商品详情展示
- 全文搜索
- 评分和评论
- 商品下载/克隆

## 6. API 设计

### 6.1 RESTful API

**Operator API**：
```
✅ POST   /api/v1/operators                    # 创建算子
✅ GET    /api/v1/operators                    # 获取算子列表（支持筛选：language, status, keyword, page, size）
✅ GET    /api/v1/operators/{id}               # 获取算子详情
✅ PUT    /api/v1/operators/{id}               # 更新算子
✅ DELETE /api/v1/operators/{id}               # 删除算子
✅ POST   /api/v1/operators/{id}/parameters      # 添加参数
✅ PUT    /api/v1/operators/{id}/parameters/{parameterId}  # 更新参数
✅ DELETE /api/v1/operators/{id}/parameters/{parameterId}  # 删除参数
✅ PATCH  /api/v1/operators/{id}/status         # 更新状态
✅ POST   /api/v1/operators/{id}/upload          # 上传代码
✅ POST   /api/v1/operators/{id}/featured        # 切换推荐
✅ POST   /api/v1/operators/{id}/download        # 增加下载量
```

**Package API**：
```
✅ POST   /api/v1/packages                     # 创建算子包
✅ GET    /api/v1/packages                     # 获取算子包列表（支持筛选）
✅ GET    /api/v1/packages/{id}                # 获取算子包详情
✅ PUT    /api/v1/packages/{id}                # 更新算子包
✅ DELETE /api/v1/packages/{id}                # 删除算子包
✅ POST   /api/v1/packages/{id}/operators      # 添加算子到包
✅ PUT    /api/v1/packages/{id}/operators/{operatorId}/order  # 更新算子顺序
✅ DELETE /api/v1/packages/{id}/operators/{operatorId}  # 从包中移除算子
```

**Auth API**：
```
✅ POST   /api/v1/auth/register                # 用户注册
✅ POST   /api/v1/auth/login                   # 用户登录
✅ POST   /api/v1/auth/refresh                 # 刷新令牌
✅ POST   /api/v1/auth/change-password           # 修改密码
```

**User API**：
```
✅ GET    /api/v1/users/profile               # 获取个人信息
✅ PUT    /api/v1/users/profile               # 更新个人信息
✅ GET    /api/v1/users/{id}                  # 获取用户详情
✅ PATCH  /api/v1/users/{id}                  # 更新用户信息（管理员）
✅ PATCH  /api/v1/users/{id}/status           # 更新用户状态
✅ PATCH  /api/v1/users/{id}/role             # 更新用户角色
```

**Execution API**：
```
✅ POST   /api/v1/execution/tasks               # 创建执行任务
✅ GET    /api/v1/execution/tasks               # 获取任务列表
✅ GET    /api/v1/execution/tasks/{id}          # 获取任务详情
✅ POST   /api/v1/execution/tasks/{id}/cancel   # 取消任务
✅ WS     /ws/execution/tasks/{id}/logs      # 任务日志 WebSocket
```

**未实现的 API**（保留供未来参考）：

```
❌ Version API
   GET    /api/v1/versions                     # 获取版本列表
   GET    /api/v1/versions/{id}                # 获取版本详情
   POST   /api/v1/versions                     # 创建版本
   PUT    /api/v1/versions/{id}                # 更新版本
   DELETE /api/v1/versions/{id}               # 删除版本
   POST   /api/v1/versions/{id}/rollback       # 版本回滚

❌ Publish API
   GET    /api/v1/publish/destinations         # 获取发布目的地列表
   GET    /api/v1/publish/history              # 获取发布历史
   POST   /api/v1/publish                       # 执行发布

❌ Market API
   GET    /api/v1/market/items                  # 获取市场商品列表
   GET    /api/v1/market/search                  # 搜索商品
   GET    /api/v1/market/items/{id}             # 获取商品详情
   POST   /api/v1/market/items/{id}/rating     # 提交评分
   POST   /api/v1/market/items/{id}/review     # 提交评论
```

## 7. 前端 UI 设计要点

### 7.1 整体布局

采用经典的左侧导航 + 顶部 Header + 内容区的管理后台布局。

### 7.2 核心页面

1. **认证页面**
   - 登录页面
   - 注册页面

2. **算子列表页面**
   - 表格布局（支持排序、筛选、分页）
   - 操作列（编辑、删除、发布）

3. **算子详情页面**
   - 基本信息展示
   - 参数配置展示
   - 版本历史（暂未实现）
   - 快速操作（创建新版本）

4. **算子创建/编辑页面**
   - 步骤式表单
   - Step 1: 基本信息（名称、描述、语言、版本）
   - Step 2: 参数配置（输入参数、输出参数）
   - Step 3: 代码编辑器

5. **算子包列表页面**
   - 卡片式布局（3 列网格）
   - 搜索和筛选
   - 快速操作（创建、编辑、删除）

6. **算子包详情页面**
   - 算子包基本信息
   - 包含算子列表（支持拖拽排序）
   - 数据流转图展示（暂未实现）

7. **算子包创建/编辑页面**
   - 基本信息（名称、描述、业务场景）
   - 版本号
   - 公开/私有设置

### 7.3 组件库

基于 Ant Design 进行二次封装。

**通用组件**：
- Layout - 布局组件
- Header - 顶部导航
- Sidebar - 侧边菜单

**算子组件**：
- ParameterForm - 参数表单
- CodeEditor - 代码编辑器（Monaco）

## 8. 实施计划

### 8.1 阶段划分

| 阶段 | 里程碑 | 预计时间 |
|------|--------|----------|
| 1 | 后端基础框架搭建完成 | Week 3 | ✅ 已完成 |
| 2 | 前端基础框架搭建完成 | Week 6 | ✅ 已完成 |
| 3 | 算子与算子包管理完成 | Week 11 | ✅ 已完成 |
| 4 | 版本管理完成 | Week 15 | ⏸️ 未完成 |
| 5 | 发布管理完成 | Week 19 | ⏸️ 未完成 |
| 6 | 算子与算子包市场完成 | Week 22 | ⏸️ 未完成 |
| 7 | 监控运维完成 | Week 25 | ⏸️ 未完成 |
| 8 | 测试优化完成 | Week 28 | ⏸️ 未完成 |
| 9 | 系统上线 | Week 30 | ⏸️ 未完成 |

**总计**：约 7.5 个月（核心功能约 5 个月已完成）

### 8.2 当前状态

**✅ 已完成**：
- [x] 后端基础框架（Spring Boot + PostgreSQL + Redis + MinIO）
- [x] 前端基础框架（React 18 + TypeScript + Ant Design）
- [x] 用户认证与授权（JWT + Spring Security）
- [x] 用户管理（CRUD + 角色权限）
- [x] 算子 CRUD（创建、读取、更新、删除）
- [x] 算子参数管理（输入/输出参数）
- [x] 算子代码文件管理（上传、下载）
- [x] 算子包 CRUD（创建、读取、更新、删除）
- [x] 算子包内的算子管理（添加、移除、拖拽排序）
- [x] 算子包顺序配置（order_index 字段）
- [x] 权限管理（RBAC）
- [x] 审计日志系统
- [x] 执行监控（WebSocket 日志流）

**⏸️ 未完成**：
- [ ] 版本管理
- [ ] 发布管理
- [ ] 算子/算子包市场
- [ ] 仪表盘

## 9. 技术要点

### 9.1 算子包顺序管理

算子包中的算子通过 `order_index` 字段指定执行顺序：

```java
@Entity
@Table(name = "package_operators")
public class PackageOperator {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @ManyToOne(fetch = FetchType.LAZY)
    private OperatorPackage operatorPackage;

    @ManyToOne(fetch = FetchType.LAZY)
    private Operator operator;

    @Column(name = "order_index", nullable = false)
    private Integer orderIndex = 0;  // 执行顺序，从 0 开始

    // 当用户在前端拖拽调整顺序后，批量更新 orderIndex
    public static void reorder(List<PackageOperator> pos) {
        for (int i = 0; i < pos.size(); i++) {
            pos.get(i).setOrderIndex(i);
        }
    }
}
```

### 9.2 枚举类型统一

**注意**：当前实现存在实体类和 DTO 使用不同枚举的问题，建议优化。

实体类内部枚举：
```java
public class Operator extends BaseEntity {
    public enum LanguageType { JAVA, PYTHON }
    public enum OperatorStatus { DRAFT, PUBLISHED, ARCHIVED }

    @Enumerated(EnumType.STRING)
    private LanguageType language;
    @Enumerated(EnumType.STRING)
    private OperatorStatus status;
}
```

DTO 使用的独立枚举（在 operator-common/enums/ 中）。

**优化建议**：
1. 全部使用 `operator-common/enums/` 中的统一枚举
2. 实体类使用 `@Enumerated(EnumType.STRING)` 直接引用 common 包枚举
3. 删除实体类中的内部枚举定义

### 9.3 发布器设计

**文件发布器**：
```java
public class FilePublisher {
    public PublishResult publish(Operator operator, Version version, FileDestinationConfig config) {
        // 1. 从 MinIO 下载算子代码文件
        byte[] codeBytes = storageService.downloadFile(operator.getCodePath());

        // 2. 根据配置打包
        File packageFile = createPackage(operator, version, codeBytes, config);

        // 3. 写入目标路径
        Path targetPath = Paths.get(config.getTargetPath());
        Files.copy(packageFile.toPath(), targetPath, StandardCopyOption.REPLACE_EXISTING);

        // 4. 记录发布历史
        PublishHistory history = new PublishHistory(operator, version, config, true);
        publishHistoryRepository.save(history);

        return PublishResult.success(targetPath.toString());
    }
}
```

**REST 接口发布器**：
```java
public class RestPublisher {
    public PublishResult publish(Operator operator, Version version, RestDestinationConfig config) {
        // 1. 准备请求数据
        Map<String, Object> requestBody = buildRequestBody(operator, version, config);

        // 2. 配置 HTTP 客户端
        WebClient client = WebClient.builder()
            .defaultHeaders(config.getHeaders())
            .build();

        // 3. 发送请求
        Mono<String> response = client.post()
            .uri(config.getUrl())
            .bodyValue(requestBody)
            .retrieve()
            .bodyToMono(String.class);

        // 4. 记录发布历史
        PublishHistory history = new PublishHistory(operator, version, config, true);
        publishHistoryRepository.save(history);

        return PublishResult.success(response.block());
    }
}
```

## 10. 风险和应对

| 风险 | 应对策略 |
|------|----------|
| REST 接口发布失败 | 记录详细错误信息，提供重试机制，支持断点续传 |
| 算子包顺序冲突 | 唯一性约束保证 orderIndex 不重复，提供自动重新编号功能 |
| 文件发布权限问题 | 提供权限校验，友好提示 |
| 前端状态管理复杂 | 使用 Zustand 统一管理，提供类型推断 |
| 性能问题 | 分页加载，虚拟滚动，缓存优化 |

## 11. 验证计划

### 11.1 功能验证

1. 创建算子并上传代码
2. 配置算子参数（输入/输出参数）
3. 创建算子包
4. 向算子包添加算子并调整顺序
5. 创建算子包版本
6. 发布算子到本地文件（暂未实现）

### 11.2 性能验证

1. API 响应时间 < 500ms
2. 全文搜索响应时间 < 100ms
3. 算子包算子列表加载时间 < 1s
4. 文件上传支持断点续传

### 11.3 安全验证

1. 权限控制验证
2. SQL 注入测试
3. XSS 攻击测试
4. 文件上传安全测试
5. REST 接口发布目标验证

---

**文档版本**: v2.0
**最后更新**: 2026-02-19
**作者**: Claude AI Assistant
